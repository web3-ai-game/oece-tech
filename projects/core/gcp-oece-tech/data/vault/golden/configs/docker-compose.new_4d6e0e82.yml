version: '3.8'

# üçÑ Ëèå‰∏ùÁΩëÁªú - ÈáçÊûÑÂêéÁöÑÂÆπÂô®Êû∂ÊûÑ
# DopplerÈõÜÊàê + DatadogÁõëÊéß + ÂÆåÊï¥ÊúçÂä°

networks:
  mycelium:
    driver: bridge
    labels:
      com.datadoghq.ad.check_names: '["network"]'
      com.datadoghq.ad.init_configs: '[{}]'

volumes:
  redis_data:
    driver: local
  postgres_data:
    driver: local
  nginx_cache:
    driver: local

services:
  # ================================================
  # Ê†∏ÂøÉÂü∫Á°ÄËÆæÊñΩ
  # ================================================
  
  # Redis - ÁºìÂ≠òÂíå‰ºöËØù
  redis:
    image: redis:7-alpine
    container_name: mycelium-redis
    restart: unless-stopped
    command: >
      redis-server
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - mycelium
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    labels:
      com.datadoghq.ad.check_names: '["redisdb"]'
      com.datadoghq.ad.init_configs: '[{}]'
      com.datadoghq.ad.instances: '[{"host":"%%host%%","port":6379}]'
      com.datadoghq.ad.logs: '[{"source":"redis","service":"redis"}]'
      service: "redis"
      env: "production"
    deploy:
      resources:
        limits:
          memory: 1200M
        reservations:
          memory: 512M

  # PostgreSQL - ËÆ∫ÂùõÊï∞ÊçÆÂ∫ì
  postgres:
    image: postgres:15-alpine
    container_name: mycelium-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-forum}
      POSTGRES_USER: ${POSTGRES_USER:-forum_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - mycelium
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-forum_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      com.datadoghq.ad.check_names: '["postgres"]'
      com.datadoghq.ad.init_configs: '[{}]'
      com.datadoghq.ad.instances: '[{"host":"%%host%%","port":5432,"username":"datadog","password":"%%env_POSTGRES_PASSWORD%%","dbname":"%%env_POSTGRES_DB%%"}]'
      com.datadoghq.ad.logs: '[{"source":"postgresql","service":"postgres"}]'
      service: "postgres"
      env: "production"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ================================================
  # GoÂêéÁ´ØÊúçÂä°
  # ================================================
  
  # Xiaoai Bot - Telegram AIÂä©Êâã
  xiaoai-bot:
    build:
      context: ./go_backend
      dockerfile: Dockerfile
      args:
        SERVICE: xiaoai
    container_name: mycelium-xiaoai
    restart: unless-stopped
    environment:
      # ‰ªéDopplerÊ≥®ÂÖ•
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_XIAOAI_TOKEN}
      BOT_OWNER_ID: ${BOT_OWNER_ID}
      
      # Gemini Keys - 25‰∏™Êô∫ËÉΩË∑ØÁî±
      GEMINI_API_KEYS: ${GEMINI_API_KEYS}
      
      # Supabase
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      
      # Redis
      REDIS_URL: redis://redis:6379
      
      # ÈÖçÁΩÆ
      LOG_LEVEL: info
      ENVIRONMENT: production
      
      # Datadog APM
      DD_AGENT_HOST: datadog-agent
      DD_TRACE_ENABLED: true
      DD_SERVICE: xiaoai-bot
      DD_VERSION: 2.0
      DD_ENV: production
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - mycelium
    labels:
      com.datadoghq.ad.logs: '[{"source":"golang","service":"xiaoai-bot"}]'
      service: "xiaoai-bot"
      env: "production"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
        reservations:
          cpus: '0.2'
          memory: 128M

  # API Gateway - Go
  api-gateway:
    build:
      context: ./go_backend
      dockerfile: Dockerfile
      args:
        SERVICE: gateway
    container_name: mycelium-gateway
    restart: unless-stopped
    environment:
      PORT: 8080
      REDIS_URL: redis://redis:6379
      POSTGRES_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      
      # Supabase
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      
      # ÂÆâÂÖ®
      JWT_SECRET: ${JWT_SECRET}
      
      # Datadog
      DD_AGENT_HOST: datadog-agent
      DD_TRACE_ENABLED: true
      DD_SERVICE: api-gateway
      DD_ENV: production
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - mycelium
    labels:
      com.datadoghq.ad.logs: '[{"source":"golang","service":"api-gateway"}]'
      service: "api-gateway"
      env: "production"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
        reservations:
          memory: 128M

  # ================================================
  # ÂâçÁ´ØÊúçÂä° (NginxÂèçÂêë‰ª£ÁêÜ)
  # ================================================
  
  nginx:
    image: nginx:alpine
    container_name: mycelium-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - nginx_cache:/var/cache/nginx
      - /var/log/nginx:/var/log/nginx
    depends_on:
      - api-gateway
    networks:
      - mycelium
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 3s
      retries: 3
    labels:
      com.datadoghq.ad.check_names: '["nginx"]'
      com.datadoghq.ad.init_configs: '[{}]'
      com.datadoghq.ad.instances: '[{"nginx_status_url":"http://%%host%%/nginx_status"}]'
      com.datadoghq.ad.logs: '[{"source":"nginx","service":"nginx","log_processing_rules":[{"type":"multi_line","name":"new_log_start_with_date","pattern":"\\d{4}\\/\\d{2}\\/\\d{2}"}]}]'
      service: "nginx"
      env: "production"
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 128M

  # ================================================
  # ÁõëÊéßÊúçÂä°
  # ================================================
  
  # Datadog Agent
  datadog-agent:
    image: gcr.io/datadoghq/agent:7
    container_name: datadog-agent
    restart: unless-stopped
    environment:
      DD_API_KEY: ${DD_API_KEY}
      DD_SITE: ${DD_SITE:-datadoghq.com}
      DD_HOSTNAME: mycelium-vps-sgp1
      
      # APM
      DD_APM_ENABLED: true
      DD_APM_NON_LOCAL_TRAFFIC: true
      
      # Êó•Âøó
      DD_LOGS_ENABLED: true
      DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL: true
      
      # ËøõÁ®ãÁõëÊéß
      DD_PROCESS_AGENT_ENABLED: true
      
      # ÂÆπÂô®ÁõëÊéß
      DD_CONTAINER_EXCLUDE: "name:datadog-agent"
      
      # Ê†áÁ≠æ
      DD_TAGS: "env:production project:mycelium-network vps:digitalocean region:sgp1"
      
      # Docker
      DD_DOCKER_LABELS_AS_TAGS: '{"service":"service","env":"environment"}'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc:/host/proc:ro
      - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /etc/passwd:/etc/passwd:ro
    networks:
      - mycelium
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

# ================================================
# ËµÑÊ∫êÈÖçÁΩÆÊÄªÁªì
# ================================================
# 
# ÊÄªÂÜÖÂ≠òÈ¢ÑÁÆó (8GBÁ≥ªÁªü):
#   Redis:        1.2GB
#   PostgreSQL:   512MB
#   Xiaoai Bot:   384MB
#   API Gateway:  384MB
#   Nginx:        128MB
#   Datadog:      256MB
#   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#   ÊÄªËÆ°ÈôêÂà∂:     ~2.9GB
#   ÂÆûÈôÖ‰ΩøÁî®:     ~1.5GB
#   Á≥ªÁªü+ÁºìÂÜ≤:    ~6.1GB
#
# 20GB SwapÂèØÁî®‰ΩúÁºìÂÜ≤
#
# ================================================
