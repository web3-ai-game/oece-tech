# 🔍 Gemini模型实测分析与路由器设计

## 📊 实际测试结果 (2025-11-10)

### 测试方法
- **测试Keys**: 3个随机Key
- **测试模型**: 6个 (基于用户提供的配额表)
- **测试指标**: 可用性、延迟、Tokens使用

### 测试结果总结

| 模型 | RPM | RPD | 状态 | 平均延迟 | 用途 |
|------|-----|-----|------|---------|------|
| **gemini-2.5-flash** | 1000 | **10000** | ✅ **可用** | 1-3秒 | **主力模型** |
| **gemini-2.5-pro** | 150 | 10000 | ✅ 可用 | 7-8秒 | 高级任务 |
| gemini-2.5-flash-preview-image | 500 | 2000 | ❌ 404 | - | 未发布 |
| gemini-2.5-flash-tts | 10 | 100 | ❌ 404 | - | 未发布 |
| gemini-2.0-flash-exp | 10 | 500 | ❌ 404 | - | 已下线 |
| imagen-4.0-fast-generate | 10 | 70 | ❌ 404 | - | 未发布 |

---

## 🎯 核心发现

### 1. gemini-2.5-flash - 主力模型
```yaml
特点:
  - 最高日配额: 10,000次/Key
  - 25个Keys总容量: 250,000次/天
  - 响应速度快: 1-3秒
  - RPM充足: 1000/分钟

适用场景:
  ✅ 群聊对话
  ✅ 日常闲聊
  ✅ 快速问答
  ✅ 吹牛扯淡
  ✅ 所有高频场景

计算:
  单Key: 10K/天
  25 Keys: 250K/天
  支持用户: ~5000人 (每人50次/天)
```

### 2. gemini-2.5-pro - 高级模型
```yaml
特点:
  - 日配额同样: 10,000次/Key
  - 但RPM受限: 150/分钟
  - 响应较慢: 7-8秒
  - 质量更高

适用场景:
  ✅ 复杂代码生成
  ✅ 深度分析
  ✅ 长文本处理
  ✅ 专业任务

建议:
  仅在需要高质量时使用
  日常对话用flash即可
```

### 3. 其他模型
```yaml
状态: 全部404
原因:
  - preview模型未正式发布
  - 实验版本已下线
  - 图片/TTS模型未开放免费层

结论: 仅flash和pro可用
```

---

## 🚀 智能路由器设计

### 核心策略

#### 1. 每日配额管理
```python
# 每天0点自动重置
- 清空所有日统计
- 恢复健康度为1.0
- 开始新一天的统计

实现:
  last_reset = redis.get('router:last_reset')
  if last_reset != today:
      reset_daily_quota()
```

#### 2. 智能权重分配
```python
# 基于剩余配额动态分配
weight = health * remaining / total_quota

优先级:
  1. 健康度高的Key (>0.8)
  2. 剩余配额多的Key
  3. 组优先级 (VIP>Premium>Normal)

示例:
  Key A: health=1.0, remaining=9000 → weight=0.9
  Key B: health=0.9, remaining=5000 → weight=0.45
  选择 Key A
```

#### 3. 实时统计
```python
# 每个Key的使用统计
统计维度:
  - 每日: router:daily_stats:{key}:{model}:{date}
  - 每周: 查询7天数据
  - 每月: 查询30天数据

查询示例:
  今日Flash使用: 127次
  剩余配额: 9873次
  健康度: 0.98
```

#### 4. 健康度评分
```python
# 动态调整
成功: health += 0.02 (max 1.0)
失败: health -= 0.15 (min 0.0)

阈值:
  >0.8: 健康，优先使用
  0.5-0.8: 警告，降低优先级
  <0.5: 危险，告警+避免使用
```

---

## 📈 容量规划

### 单Key容量
```yaml
gemini-2.5-flash:
  每分钟: 1000次
  每小时: 60000次 (理论)
  每天: 10000次 (实际限制)
  
结论: 日限额是瓶颈，不是RPM
```

### 25 Keys总容量
```yaml
理论容量:
  每天: 250,000次
  每月: 7,500,000次
  
实际可用:
  80%安全系数: 200,000次/天
  支持用户: 4000-5000人
  人均配额: 40-50次/天
```

### 不同场景用量预估
```yaml
场景1: 个人Bot (1-10用户)
  日需求: 100-500次
  Keys需求: 1个足够

场景2: 小群聊 (50人)
  日需求: 500-2000次
  Keys需求: 1-2个

场景3: 大群聊 (200人)
  日需求: 2000-10000次
  Keys需求: 1-5个

场景4: 多群+个人 (1000人)
  日需求: 20000-50000次
  Keys需求: 5-10个

场景5: 大型应用 (5000人)
  日需求: 100000-200000次
  Keys需求: 10-25个 ✅ 当前配置
```

---

## 💡 最佳实践

### 1. 模型选择
```python
# 默认使用flash
普通对话 → gemini-2.5-flash
复杂任务 → gemini-2.5-pro (明确指定)

代码示例:
  # 群聊
  key = router.get_best_key('gemini-2.5-flash', 'normal')
  
  # 代码生成
  key = router.get_best_key('gemini-2.5-pro', 'vip')
```

### 2. 配额监控
```python
# 每日检查
报告内容:
  - 今日使用量
  - 剩余配额
  - Top 5最忙的Keys
  - 健康度预警

自动化:
  每天早上8点发送日报
  配额<20%时发送告警
```

### 3. 故障处理
```python
# 自动fallback
情况1: Key配额用完
  → 切换到剩余配额最多的Key

情况2: 所有Key用完
  → 紧急告警
  → 降级服务或等待明天重置

情况3: Key健康度低
  → 自动避免使用
  → 24小时后自动恢复
```

### 4. 用户分级
```yaml
VIP (Owner):
  - 优先使用Group A
  - 可使用Pro模型
  - 无限制

Premium:
  - 优先Group B
  - 限制Pro使用
  - 日限100次

Normal:
  - 使用Group C/D
  - 仅Flash模型
  - 日限50次

Guest:
  - 仅Group D
  - 仅Flash模型
  - 日限10次
```

---

## 📊 统计示例

### 每日报告
```
📊 Gemini路由器每日报告
==================================================

🔑 Keys状态
总Keys: 25
健康Keys: 24 (96%)
警告Keys: 1 (AIzaSy...健康度0.75)

📈 模型使用情况

gemini-2.5-flash:
  今日请求: 45,327次
  平均/Key: 1,813次
  使用率: 18.1%
  剩余容量: 204,673次

gemini-2.5-pro:
  今日请求: 1,234次
  平均/Key: 49次
  使用率: 0.5%
  剩余容量: 248,766次

🏆 使用最多的Keys:
  AIzaSyA8u...: 2,156次 (健康度: 0.98)
  AIzaSyB7x...: 2,089次 (健康度: 0.99)
  AIzaSyATC...: 1,998次 (健康度: 1.0)
  AIzaSyDE8...: 1,945次 (健康度: 0.97)
  AIzaSyDyh...: 1,876次 (健康度: 1.0)

💡 建议:
  ✅ 当前使用率健康
  ✅ 所有Keys负载均衡
  ⚠️ 1个Key需要关注
```

---

## 🔧 部署建议

### 1. 生产环境
```yaml
必需组件:
  ✅ Redis - 持久化统计
  ✅ Telegram Bot - 告警通知
  ✅ 定时任务 - 每日报告

配置:
  - Redis持久化: appendonly yes
  - 告警阈值: 配额<20%
  - 报告时间: 每天8:00
```

### 2. 监控指标
```yaml
关键指标:
  - 每日总请求数
  - 平均响应延迟
  - Keys健康度分布
  - 配额使用率
  - 失败率

告警条件:
  - 配额使用>80%
  - Keys健康度<0.5
  - 失败率>5%
  - 所有Keys配额耗尽
```

### 3. 优化策略
```yaml
性能优化:
  - 使用连接池
  - 批量统计查询
  - 异步记录日志

成本优化:
  - 优先使用flash
  - 避免重复请求
  - 实现用户限流

可靠性:
  - 多Key冗余
  - 自动故障转移
  - 每日配额重置
```

---

## 🎯 总结

### 核心优势
1. ✅ **flash模型最优** - 10K日配额，适合高频场景
2. ✅ **25 Keys = 250K/天** - 支持5000人规模应用
3. ✅ **每日自动重置** - 配额管理简单
4. ✅ **智能权重分配** - 自动负载均衡
5. ✅ **完整统计** - 可追踪每个Key使用

### 适用场景
- ✅ Telegram群聊Bot
- ✅ 个人AI助手
- ✅ 客服机器人
- ✅ 内容生成工具
- ✅ 所有高频AI应用

### 不适用场景
- ❌ 图片生成 (模型未开放)
- ❌ 语音合成 (模型未开放)
- ❌ 超大规模应用 (>10万/天需付费)

---

**文件**: smart_router_final.py  
**状态**: ✅ 测试通过，生产就绪  
**更新**: 2025-11-10
