# 23 键集群转速与日配额（免费层·文字模型）

更新时间：2025-11-10

---

## 1. 可用文字模型与单 Key 限额（按“稳定表”）

- gemini-2.0-flash-lite
  - RPM: 30 / min
  - RPD: 200 / day
  - TPM: 1,000,000 / min
- gemini-2.0-flash
  - RPM: 15 / min
  - RPD: 200 / day
  - TPM: 1,000,000 / min
- gemini-2.5-flash-lite
  - RPM: 15 / min
  - RPD: 1,000 / day
  - TPM: 250,000 / min
- gemini-2.5-flash
  - RPM: 10 / min
  - RPD: 250 / day
  - TPM: 250,000 / min
- gemini-2.5-pro（仅 Pro/管理员特权）
  - RPM: 2 / min
  - RPD: 50 / day
  - TPM: 125,000 / min

说明：体检实测显示 text-out 模型普遍可用率高（≈87%）。2.5-pro 易触发 429，实际稳定吞吐略低于表面配额，建议预留安全系数 80%。

---

## 2. 23 键集群容量（“全上”极限）

下表给出“理论极限”和“建议安全值（80%）”。

| 模型 | 集群 RPM 极限 (23 键) | 建议安全 RPM (80%) | 集群 RPD 极限 (23 键) | 建议安全 RPD (80%) |
|---|---:|---:|---:|---:|
| gemini-2.0-flash-lite | 690 /min | 552 /min | 4,600 /day | 3,680 /day |
| gemini-2.0-flash | 345 /min | 276 /min | 4,600 /day | 3,680 /day |
| gemini-2.5-flash-lite | 345 /min | 276 /min | 23,000 /day | 18,400 /day |
| gemini-2.5-flash | 230 /min | 184 /min | 5,750 /day | 4,600 /day |
| gemini-2.5-pro | 46 /min | 36 /min | 1,150 /day | 920 /day |

注：2.0-flash(-lite) 的 RPD（200/天）非常低，持续高 RPM 会在数分钟内打满当天限额，建议仅突发使用。

---

## 3. 业务场景映射与路由建议

- 默认“暗恋私聊模式”（所有普通用户，含会员 1）
  - 模型：gemini-2.5-flash
  - 备选：gemini-2.5-flash-lite（限速/故障时）
- 群聊（公用池）
  - 模型：gemini-2.5-flash-lite（RPD 1,000/Key，适合群聊高频）
  - 会话策略：关键词触发后一轮 5 次回复；单群并发最多 5 人
- Pro（充值/年费，等级 2/3）
  - DM 可升级至 gemini-2.5-flash 或按需启用 2.5-pro（受限流）
- Admin（独立权限）
  - “工作模式”：gemini-2.5-pro，23 键轮询
  - 目标速率：1 次/1.5 秒 ≈ 40 /min（低于集群 46 /min 极限，安全）
  - 可挂预设任务、外部交互（爬数、分析、批处理）

---

## 4. 两个“疑似异常”Key的复测建议

- 请提供这两个 Key 的短码（前 6/后 6），我将对以下文字模型逐一测试：
  - 2.5-flash-lite / 2.5-flash / 2.0-flash-lite / 2.0-flash / 2.5-pro
- 目的：判断是否为某单模型 RPD 打满而导致的不可用，其他模型是否仍可用。
- 工具：`tools/gemini_key_audit.py --keys <k1> <k2> --burst 3`（轻量突发）

---

## 5. 数据持久化与异步分析（建议）

- 存储：PostgreSQL（或 Supabase），表结构（简化）：
  - users(uid, tier, is_admin, created_at)
  - chats(chat_id, type[group/private], title, created_at)
  - messages(id, chat_id, user_id, role[user/assistant], text, tokens, model, key_short, created_at)
  - sessions(chat_id, user_id, mode[group5/dm], turns, last_at)
  - quotas(date, model, key_short, rpm_used, rpd_used)
- 采集：
  - Bot 实时落库（或 Redis->每小时批量落库，避免流量爆炸）
  - 批处理：每小时执行一次归档/聚合（近 24h 请求数、失败率、热点群/人）
- 分析：
  - 适合使用 Deepnote（协作 Notebook）或 Camber（科学计算）按需跑 Notebook/模拟/报表
  - 生产任务建议独立 Worker（Python/Go）+ 定时器，而非仅 Notebook

---

## 6. Go 高并发后端（草案）

- 架构：Gin/Fiber + Redis（速率）+ Postgres（持久）
- 关键模块：
  - 路由服务：按模型/Key 粒度的令牌桶（RPM），按日配额（RPD）熔断；23 键轮询 + 健康度降权
  - 队列：内存 Channel + 限流器；Admin 工作模式专线（高优先级）
  - 监控：Prometheus 指标（QPS、P50/P95、429、错误、各模型/Key 用量）
- 目标吞吐：
  - 常规 50 在线 ≪ 集群能力（见上表），可轻松承载
  - Admin 工作模式：40/min（1.5s/次），接近 2.5-pro 安全极限（36-46/min），建议配 10% 余量

---

## 7. 配置与运营建议

- 安全系数：按 80% 运行；模型日配额在 70% 时预警（Telegram）
- 速率分配：群聊独立池（2.5-flash-lite），DM 独立池（2.5-flash），Admin-Pro 专线（2.5-pro）
- 回退顺序：
  - DM：2.5-flash → 2.5-flash-lite → 2.0-flash
  - 群：2.5-flash-lite → 2.0-flash-lite → 2.0-flash
- 记忆：
  - 私聊：持久化（文件/DB），不清除则一直保留
  - 群聊：每用户 5 次一轮，保留最近 5 轮于内存/Redis（回收 TTL）

---

## 8. 下一步

- 提供两个“异常 Key”短码以复测
- 确认可落库的数据库连接（Postgres/Supabase）与目标表结构
- 是否需要我草拟 Go 后端骨架（含速率控制、路由、指标）并提交
