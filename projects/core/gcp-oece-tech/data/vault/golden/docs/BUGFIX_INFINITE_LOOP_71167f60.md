# ğŸ› ä¿®å¤æ— é™å¾ªç¯Bug

## âŒ é—®é¢˜æè¿°

Botåœ¨5è½®å¯¹è¯å**ä¸åœæ­¢**ï¼Œç»§ç»­å›å¤ç”¨æˆ·çš„æ¯æ¡æ¶ˆæ¯ã€‚

### é”™è¯¯è¡Œä¸º
```
ç”¨æˆ·: å°çˆ± ä½ å¥½
å°çˆ±: [1/5]

ç”¨æˆ·: ç»§ç»­
å°çˆ±: [2/5]

ç”¨æˆ·: ç»§ç»­
å°çˆ±: [3/5]

ç”¨æˆ·: ç»§ç»­
å°çˆ±: [4/5]

ç”¨æˆ·: ç»§ç»­
å°çˆ±: [5/5]

ç”¨æˆ·: è¿˜åœ¨å—ï¼Ÿ
å°çˆ±: [1/5] âŒ åº”è¯¥åœæ­¢ä½†ç»§ç»­å›å¤

ç”¨æˆ·: ä½ å¥½
å°çˆ±: [2/5] âŒ ç»§ç»­å›å¤

... æ— é™å¾ªç¯
```

---

## ğŸ” æ ¹æœ¬åŸå› 

### åŸä»£ç é€»è¾‘
```python
def increment_group_round(self, chat_id, user_id, bot_name):
    new_round = redis_client.incr(key)
    
    # è¶…è¿‡5è½®é‡ç½®ä¸º1
    if new_round > 5:
        redis_client.set(key, 1)  # âŒ é‡ç½®ä¸º1ï¼Œç»§ç»­å¯¹è¯
        return 1
    
    return new_round
```

**é—®é¢˜**: è¶…è¿‡5è½®åé‡ç½®ä¸º1ï¼Œå¯¼è‡´å¯¹è¯æ°¸è¿œä¸ä¼šç»“æŸï¼

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–°ä»£ç é€»è¾‘
```python
def increment_group_round(self, chat_id, user_id, bot_name):
    new_round = redis_client.incr(key)
    
    # è¶…è¿‡5è½®åˆ é™¤keyï¼ˆåœæ­¢å¯¹è¯ï¼‰
    if new_round > 5:
        redis_client.delete(key)  # âœ… åˆ é™¤key
        return 0  # âœ… è¿”å›0è¡¨ç¤ºç»“æŸ
    
    return new_round
```

### å¤„ç†é€»è¾‘
```python
new_round = memory.increment_group_round(chat_id, user_id, bot_name)

# å¦‚æœè¿”å›0ï¼Œåœæ­¢å›å¤
if new_round == 0:
    logger.info("5è½®å¯¹è¯ç»“æŸ")
    return  # âœ… ç›´æ¥è¿”å›ï¼Œä¸å›å¤
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æ­£ç¡®è¡Œä¸º
```
ç”¨æˆ·: å°çˆ± ä½ å¥½
å°çˆ±: @ç”¨æˆ· xxx [1/5]

ç”¨æˆ·: ç»§ç»­
å°çˆ±: @ç”¨æˆ· xxx [2/5]

ç”¨æˆ·: ç»§ç»­
å°çˆ±: @ç”¨æˆ· xxx [3/5]

ç”¨æˆ·: ç»§ç»­
å°çˆ±: @ç”¨æˆ· xxx [4/5]

ç”¨æˆ·: ç»§ç»­
å°çˆ±: @ç”¨æˆ· xxx [5/5]

ç”¨æˆ·: è¿˜åœ¨å—ï¼Ÿ
å°çˆ±: (ä¸å›å¤) âœ… æ­£ç¡®åœæ­¢

ç”¨æˆ·: ä½ å¥½
å°çˆ±: (ä¸å›å¤) âœ… ä¿æŒåœæ­¢

ç”¨æˆ·: å°çˆ± å¸®å¿™
å°çˆ±: @ç”¨æˆ· xxx [1/5] âœ… é‡æ–°è§¦å‘å¼€å§‹æ–°å¯¹è¯
```

---

## ğŸ“Š RedisçŠ¶æ€å˜åŒ–

### ä¿®å¤å‰
```bash
# ç¬¬1è½®
group_round:xiaoai:123:456 = 1

# ç¬¬5è½®
group_round:xiaoai:123:456 = 5

# ç¬¬6è½®
group_round:xiaoai:123:456 = 1  âŒ é‡ç½®ä¸º1ï¼Œç»§ç»­å¯¹è¯
```

### ä¿®å¤å
```bash
# ç¬¬1è½®
group_round:xiaoai:123:456 = 1

# ç¬¬5è½®
group_round:xiaoai:123:456 = 5

# ç¬¬6è½®
group_round:xiaoai:123:456 = (ä¸å­˜åœ¨) âœ… Keyè¢«åˆ é™¤ï¼Œå¯¹è¯ç»“æŸ
```

---

## ğŸ”§ æ¸…é™¤æ—§çŠ¶æ€

å¦‚æœBotè¿˜åœ¨æ— é™å¾ªç¯ï¼Œæ¸…é™¤RedisçŠ¶æ€ï¼š

```bash
# æ¸…é™¤æ‰€æœ‰å¯¹è¯çŠ¶æ€
redis-cli keys "group_round:*" | xargs redis-cli del

# æ¸…é™¤ç‰¹å®šç”¨æˆ·
redis-cli del "group_round:xiaoai:-1001234567890:123456789"
```

---

## âœ… ä¿®å¤ç¡®è®¤

### æ£€æŸ¥ç‚¹
- âœ… 5è½®åBotåœæ­¢å›å¤
- âœ… ç”¨æˆ·ç»§ç»­å‘æ¶ˆæ¯ä¸è§¦å‘å›å¤
- âœ… é‡æ–°è¯´å…³é”®è¯å¯ä»¥å¼€å§‹æ–°å¯¹è¯
- âœ… æ–°å¯¹è¯ä»[1/5]å¼€å§‹

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `multi_bot_v3.py` - ä¸»ç¨‹åºï¼ˆå·²ä¿®å¤ï¼‰
- `run_multi_bots_v3.sh` - å¯åŠ¨è„šæœ¬

---

**Bugå·²ä¿®å¤ï¼è¯·é‡æ–°æµ‹è¯•** ğŸ‰

**æµ‹è¯•æ­¥éª¤**:
1. åœ¨ç¾¤é‡Œå‘é€: `å°çˆ± ä½ å¥½`
2. è¿ç»­å‘é€5æ¡æ¶ˆæ¯
3. ç¬¬6æ¡æ¶ˆæ¯Botåº”è¯¥ä¸å›å¤
4. é‡æ–°è¯´ `å°çˆ± å¸®å¿™` å¼€å§‹æ–°å¯¹è¯
