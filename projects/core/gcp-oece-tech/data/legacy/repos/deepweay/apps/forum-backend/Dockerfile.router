# =====================================================
# ğŸ„ Gemini Router - è½®è¯¢æœåŠ¡
# å¤„ç†25kè¿ç¯æ¡¶è¯·æ±‚
# =====================================================

FROM python:3.11-alpine

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ä¾èµ–
RUN apk add --no-cache \
    gcc \
    musl-dev \
    && rm -rf /var/cache/apk/*

# åˆ›å»ºrequirements
RUN echo "aiohttp==3.9.1" > requirements.txt && \
    echo "redis==5.0.1" >> requirements.txt && \
    echo "python-dotenv==1.0.0" >> requirements.txt

# å®‰è£…PythonåŒ…
RUN pip install --no-cache-dir -r requirements.txt && \
    pip cache purge

# å¤åˆ¶è·¯ç”±å™¨ä»£ç 
COPY gemini_router.py .

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1000 router && \
    adduser -D -u 1000 -G router router && \
    chown -R router:router /app

USER router

# ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
    CMD python -c "import aiohttp; import sys; sys.exit(0)"

# å¯åŠ¨æœåŠ¡
CMD ["python", "-u", "gemini_router.py"]
