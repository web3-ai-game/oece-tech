# 🤖 多Bot群聊系统 V2 - 增强版

## 🎯 核心改进

### 1. **@用户名回复格式** ✅
所有Bot回复都会@用户名：
```
@username 我明白你的感受 😊 [1/5]
```

### 2. **5轮对话追踪** ✅
小爱同学会追踪每个用户的对话轮次：
```
用户A第1次: @username [1/5]
用户A第2次: @username [2/5]
...
用户A第5次: @username [5/5]
用户A第6次: @username [1/5] (重置)
```

### 3. **独立Bot人格** ✅

#### 小爱同学 (@svskilo_bot)
- **角色**: 群管理 + 5轮对话追踪
- **人格**: 温暖、理解、支持
- **触发**: 关键词触发
- **回复率**: 100% (被触发时)
- **特点**: 
  - @用户名回复
  - 显示轮次 [X/5]
  - 记忆每个用户的对话

**触发关键词**:
- 简体: 小爱、小爱同学、群主、管理、我操、都来、接茬
- 繁体: 小愛、小愛同學、群主、管理、我操、都來、接茬
- 英文: xiaoai, admin, manager, help, hey

#### 倩倩姐 (@qitiandashengqianqian_bot)
- **角色**: 高冷女神
- **人格**: 高冷、简洁、偶尔温柔
- **触发**: 随机 15%
- **回复率**: 15%
- **特点**:
  - 简短回复
  - 高冷风格
  - @用户名

**回复示例**:
```
@username 嗯。
@username 知道了。
@username 随便。
@username 哦。
```

#### Notion助手 (@svs_notion_bot)
- **角色**: 专业知识分享
- **人格**: 专业、理性、博学
- **触发**: 随机 12%
- **回复率**: 12%
- **特点**:
  - 专业术语
  - 引用概念
  - @用户名

**回复示例**:
```
@username 根据我的了解，这个问题需要从多个角度分析 📚
@username 建议参考相关文献和资料 💡
@username 从专业角度来看，这涉及到几个关键概念 🔍
```

---

## 🎭 群聊场景

### 场景1: 用户触发小爱同学
```
用户A: 小爱 帮我查一下
小爱: @用户A 让我来帮你 💝 [1/5]

[30%概率触发另一个Bot]
倩倩姐: @用户A 嗯。
```

### 场景2: 5轮对话追踪
```
用户A: 小爱 你好 (第1次)
小爱: @用户A 我明白你的感受 😊 [1/5]

用户A: 小爱 帮忙 (第2次)
小爱: @用户A 让我来帮你 💝 [2/5]

用户A: 小爱 谢谢 (第3次)
小爱: @用户A 我一直在这里 🌟 [3/5]

用户A: 小爱 再见 (第4次)
小爱: @用户A 别担心，慢慢说 💫 [4/5]

用户A: 小爱 拜拜 (第5次)
小爱: @用户A 我懂你的意思 ✨ [5/5]

用户A: 小爱 还在吗 (第6次)
小爱: @用户A 我明白你的感受 😊 [1/5] (重置)
```

### 场景3: 多用户隔离
```
用户A: 小爱 你好
小爱: @用户A 我明白你的感受 😊 [1/5]

用户B: 小爱 帮忙
小爱: @用户B 让我来帮你 💝 [1/5]

用户A: 小爱 谢谢
小爱: @用户A 我一直在这里 🌟 [2/5]
```

### 场景4: 随机Bot轰炸
```
用户: 今天吃什么？

[15%概率]
倩倩姐: @用户 随便。

[12%概率]
Notion助手: @用户 根据我的了解，这个问题需要从多个角度分析 📚
```

---

## 🔧 技术实现

### Redis存储结构
```
conv:{chat_id}:{user_id} = 轮次 (1-5)
过期时间: 1小时
```

### 回复逻辑
```python
1. 检查是否Bot自己的消息 → 忽略
2. 检查是否触发小爱同学 → 100%回复 + @用户名 + [X/5]
3. 随机触发倩倩姐 (15%) → @用户名 + 高冷回复
4. 随机触发Notion助手 (12%) → @用户名 + 专业回复
5. 小爱回复后30%概率触发另一个Bot
```

---

## 🚀 启动步骤

### 步骤1: 停止旧版本
```bash
pkill -f multi_bot_system
pkill -f simple_test_bot
```

### 步骤2: 启动V2系统
```bash
cd /mnt/volume_sgp1_01/svs
./run_multi_bots_v2.sh
```

### 步骤3: 验证运行
```bash
# 查看进程
ps aux | grep multi_bot_v2

# 查看日志
tail -f /tmp/bot_v2.log
```

---

## 🧪 测试场景

### 测试1: 关键词触发
```
在群里发送: 小爱 你好
预期: @你的用户名 我明白你的感受 😊 [1/5]
```

### 测试2: 5轮追踪
```
连续5次触发小爱同学
预期: 轮次从 [1/5] 到 [5/5]
第6次自动重置为 [1/5]
```

### 测试3: 多用户隔离
```
用户A和用户B分别触发
预期: 各自独立的轮次计数
```

### 测试4: 随机回复
```
发送普通消息 (不含关键词)
预期: 
  - 倩倩姐 15%概率回复
  - Notion助手 12%概率回复
```

---

## 📊 数据统计

### Redis查询
```bash
# 查看所有对话
redis-cli keys "conv:*"

# 查看特定用户轮次
redis-cli get "conv:{chat_id}:{user_id}"

# 清空所有对话
redis-cli flushdb
```

---

## 🐛 故障排查

### 问题1: Bot不回复
**检查**:
```bash
# 1. 确认Bot运行
ps aux | grep multi_bot_v2

# 2. 确认Redis运行
redis-cli ping

# 3. 确认群组隐私模式关闭
@BotFather → /mybots → Bot Settings → Group Privacy → Turn Off
```

### 问题2: 轮次不对
**解决**:
```bash
# 清空Redis
redis-cli flushdb

# 重启Bot
pkill -f multi_bot_v2
./run_multi_bots_v2.sh
```

### 问题3: @用户名不显示
**原因**: 用户没有设置username
**解决**: Bot会使用first_name代替

---

## 🎉 V2改进总结

| 功能 | V1 | V2 |
|------|----|----|
| @用户名回复 | ❌ | ✅ |
| 轮次显示 | ❌ | ✅ [X/5] |
| 5轮追踪 | ❌ | ✅ |
| 独立人格 | ⚠️ | ✅ |
| 高冷倩倩姐 | ❌ | ✅ |
| 专业Notion | ⚠️ | ✅ |
| 多Bot轰炸 | ❌ | ✅ 30%概率 |

---

**V2系统已就绪，准备测试！** 🚀
