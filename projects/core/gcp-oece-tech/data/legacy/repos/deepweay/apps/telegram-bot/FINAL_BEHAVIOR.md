# 🎯 最终行为说明

## ✅ 完整对话流程

### 场景1: 正常5轮对话
```
用户: 小爱 你好
小爱: @用户 我明白你的感受 😊 [1/5]

用户: 今天天气不错
小爱: @用户 让我来帮你 💝 [2/5]

用户: 你觉得呢
小爱: @用户 我一直在这里 🌟 [3/5]

用户: 谢谢
小爱: @用户 别担心，慢慢说 💫 [4/5]

用户: 再见
小爱: @用户 我懂你的意思 ✨ [5/5]

用户: 还在吗？
小爱: (不回复) ✅ 5轮结束
```

### 场景2: 5轮后立即重新触发
```
用户: 小爱 你好
小爱: @用户 xxx [1/5]

... (5轮对话)

小爱: @用户 xxx [5/5]

用户: 小爱 帮忙 (立即触发)
小爱: @用户 xxx [1/5] ✅ 立即开始新对话
```

### 场景3: 对话中触发限制
```
用户A: 小爱 你好
小爱: @用户A xxx [1/5]

用户B: 小爱 帮忙 (对话进行中)
小爱: ⏰ @用户B 对话进行中，请等待 XX 秒

(60秒后)
用户B: 小爱 帮忙
小爱: @用户B xxx [1/5] ✅ 可以触发
```

---

## 🔑 核心规则

### 1. 5轮对话系统
- ✅ 触发后连续5轮
- ✅ 不需要每次说关键词
- ✅ 5轮后自动停止

### 2. 触发限制（60秒）
- ✅ **只在对话进行中**限制
- ✅ 5轮结束后**立即**可以重新触发
- ✅ 不需要等待60秒

### 3. 多用户独立
- ✅ 每个用户独立计数
- ✅ 用户A的对话不影响用户B
- ✅ 同时支持多个用户

---

## 📊 状态机

```
[空闲] 
  ↓ 用户说"小爱"
[对话中 1/5] ← 60秒限制生效
  ↓ 用户继续说话
[对话中 2/5]
  ↓
[对话中 3/5]
  ↓
[对话中 4/5]
  ↓
[对话中 5/5]
  ↓ 5轮结束
[空闲] ← 60秒限制解除，可立即重新触发
```

---

## 🧪 测试用例

### 测试1: 5轮停止
```
1. 小爱 你好 → [1/5] ✅
2. 继续 → [2/5] ✅
3. 继续 → [3/5] ✅
4. 继续 → [4/5] ✅
5. 继续 → [5/5] ✅
6. 继续 → (不回复) ✅
```

### 测试2: 立即重新触发
```
1-5. (完成5轮)
6. 小爱 帮忙 → [1/5] ✅ 立即开始
```

### 测试3: 对话中限制
```
用户A: 小爱 你好 → [1/5]
用户B: 小爱 帮忙 → ⏰ 请等待 XX 秒 ✅
```

---

## 💡 关键改进

### 之前的问题
- ❌ 5轮后继续回复（无限循环）
- ❌ 5轮后需要等60秒才能重新触发

### 现在的行为
- ✅ 5轮后立即停止
- ✅ 5轮后立即可以重新触发
- ✅ 只在对话进行中限制60秒

---

## 🔧 技术实现

### Redis Key管理
```python
# 对话轮次
group_round:{bot}:{chat_id}:{user_id} = 1-5

# 触发限制（只在对话中存在）
trigger_limit:{bot}:{chat_id}:{user_id} = 1 (TTL: 60秒)
```

### 5轮结束处理
```python
if new_round == 0:  # 超过5轮
    if is_triggered:  # 如果是关键词触发
        # 清除限制
        redis_client.delete(limit_key)
        # 立即开始新对话
        new_round = 1
    else:  # 普通消息
        return  # 不回复
```

---

## ✅ 验证清单

- ✅ 5轮后停止回复
- ✅ 5轮后立即可以重新触发
- ✅ 对话中60秒限制
- ✅ 多用户独立
- ✅ 轮次正确显示

---

**系统已完善！** 🎉

**立即测试**：
1. 完成5轮对话
2. 立即说 `小爱 帮忙`
3. 应该立即开始新对话 [1/5]
