# 🧠 小爱同学记忆系统使用指南

## ✅ 已实现功能

### 核心特性
- **5轮对话记忆** - 自动记住最近5轮对话
- **关键词触发** - 智能识别情感关键词
- **上下文理解** - 基于历史对话理解意图
- **25个Keys轮询** - 高并发支持

---

## 🧠 记忆系统工作原理

### 对话历史存储

```python
# 每个用户独立存储
user_memories = {
    6136230855: [
        {'role': 'user', 'content': '你好', 'time': '2025-11-10 10:00:00'},
        {'role': 'assistant', 'content': '你好啊！', 'time': '2025-11-10 10:00:01'},
        {'role': 'user', 'content': '今天天气怎么样', 'time': '2025-11-10 10:01:00'},
        {'role': 'assistant', 'content': '...', 'time': '2025-11-10 10:01:02'},
        # ... 最多保留10条（5轮对话）
    ]
}
```

### 自动管理
- **自动保存** - 每次对话后自动保存
- **自动清理** - 超过5轮自动删除旧记忆
- **独立存储** - 每个用户的记忆互不干扰

---

## 🎯 关键词触发系统

### 支持的关键词

| 关键词 | 情感类型 | 重要度 | 效果 |
|--------|---------|--------|------|
| 爱你 | love | 10 | 用更深情的语气回复 |
| 喜欢你 | like | 8 | 表达欣喜和亲近 |
| 想你 | miss | 7 | 温柔体贴的回应 |
| 永远 | promise | 9 | 认真郑重的承诺 |
| 在一起 | together | 9 | 甜蜜的回应 |
| 承诺/约定 | promise | 8/7 | 庄重的语气 |
| 帮我 | help | 5 | 进入任务模式 |
| 什么是 | question | 4 | 详细解答模式 |
| 怎么/为什么 | question | 4 | 教学模式 |

### 触发效果

当检测到关键词时，AI会：
1. **识别情感** - 理解用户的情绪状态
2. **调整语气** - 使用更符合场景的语气
3. **深入回复** - 提供更有温度的回应

---

## 📱 使用示例

### 例子1：多轮对话（带记忆）

```
用户: 你好
Bot: 你好！很高兴见到你！😊

用户: 我今天学习了Python
Bot: 哇，Python很有用的！你学了哪些内容呢？

用户: 我学了列表和字典
Bot: 很棒！列表和字典是Python的基础数据结构...

用户: 刚才那个字典怎么用？  ← 注意：这里Bot会记住"刚才"指的是字典
Bot: 字典(dict)的使用很简单！比如刚才提到的...
```

**Bot记住了**：
- 第1轮：打招呼
- 第2轮：学了Python
- 第3轮：学了列表和字典
- 第4轮：询问字典用法（能理解"刚才"的上下文）

---

### 例子2：关键词触发

```
用户: 我喜欢你
Bot: 谢谢你这么说！我也很喜欢和你聊天呢~ 😊💕
     (检测到"喜欢你"关键词，用更温暖的语气)

用户: 你能帮我写个代码吗
Bot: 当然可以！很乐意帮助你。你想写什么样的代码呢？
     (检测到"帮我"关键词，进入任务辅助模式)

用户: 什么是机器学习
Bot: 机器学习(Machine Learning)是人工智能的一个分支...
     (检测到"什么是"关键词，进入详细解答模式)
```

---

### 例子3：上下文连贯对话

```
用户: 推荐一本Python书
Bot: 我推荐《Python编程：从入门到实践》，这本书...

用户: 这本书难吗？
Bot: 《Python编程：从入门到实践》其实不难！它很适合初学者...
     (Bot记住了刚才推荐的书名)

用户: 那还有其他的吗？
Bot: 当然！除了刚才那本，还有《流畅的Python》...
     (Bot记住了之前的推荐)
```

---

## 🔧 管理命令

### 查看记忆
```
/memory
```
显示你当前的对话记忆。

### 清除记忆
```
/clear
```
清除所有对话记忆，重新开始。

### 查看状态
```
/status
```
查看当前记忆轮数和系统状态。

---

## 💡 最佳实践

### 1. 连续对话
- ✅ 连续提问，Bot会记住上下文
- ✅ 可以说"刚才"、"之前"等指代词
- ✅ Bot会理解对话的连贯性

### 2. 使用关键词
- ✅ 自然使用关键词，不用特意强调
- ✅ 关键词会触发更好的回复
- ✅ 可以组合使用多个关键词

### 3. 记忆管理
- ✅ 每次对话自动保存
- ✅ 超过5轮会自动清理
- ✅ 需要重新开始时用 `/clear`

### 4. 避免的情况
- ❌ 不要发送过长消息（>1000字）
- ❌ 不要在一条消息中问太多问题
- ❌ 记忆已满时，旧对话会被清除

---

## 🔬 技术实现

### 记忆存储
```python
def add_to_memory(user_id, user_msg, ai_response):
    # 添加用户消息和AI回复
    user_memories[user_id].append({
        'role': 'user',
        'content': user_msg,
        'time': datetime.now().isoformat()
    })
    user_memories[user_id].append({
        'role': 'assistant',
        'content': ai_response,
        'time': datetime.now().isoformat()
    })
    
    # 只保留最近5轮（10条消息）
    if len(user_memories[user_id]) > 10:
        user_memories[user_id] = user_memories[user_id][-10:]
```

### 构建上下文Prompt
```python
def build_context_prompt(user_id, current_msg, first_name):
    history = get_conversation_history(user_id)
    keywords = detect_keywords(current_msg)
    
    # 构建系统提示 + 历史对话 + 当前消息
    prompt = f"""你是小爱同学...
    
【最近对话历史】
用户: {历史消息1}
你: {历史回复1}
...

【当前消息】
用户: {current_msg}

请回复："""
    
    return prompt
```

### 关键词检测
```python
def detect_keywords(text):
    detected = []
    for keyword, info in KEYWORD_TRIGGERS.items():
        if keyword in text:
            detected.append({
                'keyword': keyword,
                'emotion': info['emotion'],
                'importance': info['importance']
            })
    return detected
```

---

## 📊 对比：之前 vs 现在

### 之前（无记忆）
```
用户: 你好
Bot: 你好！

用户: 刚才说什么来着？
Bot: 我不知道你指的是什么...  ← 没有记忆
```

### 现在（有记忆）
```
用户: 你好
Bot: 你好！

用户: 刚才说什么来着？
Bot: 刚才我们打了招呼呀！😊  ← 有记忆
```

---

## 🚀 快速开始

1. **启动Bot**
```bash
./START_ENHANCED_BOT.sh
```

2. **开始对话**
```
打开Telegram → 找到"小爱同学" → 发送消息
```

3. **体验记忆**
```
连续发几条消息，然后说"刚才"试试！
```

4. **尝试关键词**
```
说"我喜欢你"或"帮我写代码"看看效果
```

---

## 🎉 开始使用

**现在就试试吧！**

发送连续的消息，体验5轮对话记忆的强大功能！

Bot会记住：
- ✅ 你说过的话
- ✅ 它回复的内容
- ✅ 对话的上下文
- ✅ 你的情感表达

**享受有记忆的智能对话！** 🧠💬✨
