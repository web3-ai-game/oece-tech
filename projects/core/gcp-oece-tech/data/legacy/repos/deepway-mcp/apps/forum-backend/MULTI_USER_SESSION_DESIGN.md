# ğŸ¯ å°çˆ±åŒå­¦å¤šç”¨æˆ·ä¼šè¯ç®¡ç†ç³»ç»Ÿè®¾è®¡

## ğŸ“‹ éœ€æ±‚åˆ†æ

### æ ¸å¿ƒåŠŸèƒ½
```yaml
1. å¤šç”¨æˆ·å¹¶å‘å¯¹è¯:
   - æœ€å¤š5ä¸ªç”¨æˆ·åŒæ—¶å¯¹è¯
   - æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„5è½®è®°å¿†
   - ç”¨æˆ·Aå’Œç”¨æˆ·Bäº’ä¸å¹²æ‰°

2. å¯¹è¯è½®æ•°æ§åˆ¶:
   - è¢«æåŠåå¼€å§‹è®¡æ•°
   - 5è½®åè‡ªåŠ¨ç»“æŸ
   - å†æ¬¡æåŠé‡æ–°å¼€å§‹

3. ç”¨æˆ·é™æµ:
   - Owner: æ— é™åˆ¶
   - æ™®é€šç”¨æˆ·: æ¯å¤©10æ¬¡
   - æ¯æ¬¡æœ€å¤š5è½®å¯¹è¯

4. æ™ºèƒ½è¯­è¨€é€‚é…:
   - ä¸­æ–‡ç®€ä½“: å›å¤é•¿åº¦ 0.8-1.0x
   - ä¸­æ–‡ç¹ä½“: å›å¤é•¿åº¦ 0.8-1.0x
   - è‹±æ–‡: å›å¤é•¿åº¦ 1.2-1.5x
   - æ ¹æ®ç”¨æˆ·è¯­è¨€åŠ¨æ€è°ƒæ•´

5. Tokenä¼˜åŒ–:
   - çŸ­æ¶ˆæ¯åˆå¹¶å¤„ç†
   - é¿å…æµªè´¹é…é¢
   - æ™ºèƒ½å‹ç¼©å†å²
```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„
```
Telegramç¾¤ç»„
    â”‚
    â”œâ”€> User A @å°çˆ± ä½ å¥½
    â”œâ”€> User B @å°çˆ± é—®é¢˜
    â””â”€> User C @å°çˆ± æŸ¥è¯¢
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Telegram Bot (Go)                â”‚
â”‚  â€¢ æ¶ˆæ¯æ¥æ”¶ä¸è§£æ                     â”‚
â”‚  â€¢ ç”¨æˆ·è¯†åˆ« (@æåŠæ£€æµ‹)               â”‚
â”‚  â€¢ å‘½ä»¤å¤„ç† (/help, /stats)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Session Manager (æ ¸å¿ƒæ¨¡å—)          â”‚
â”‚  â€¢ å¤šç”¨æˆ·ä¼šè¯ç®¡ç†                     â”‚
â”‚  â€¢ 5è½®è®°å¿†ç»´æŠ¤                        â”‚
â”‚  â€¢ ä¼šè¯è¿‡æœŸå¤„ç†                       â”‚
â”‚  â€¢ å¹¶å‘æ§åˆ¶(æœ€å¤š5ä¸ª)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€> Redis (ç¼“å­˜)
         â”‚    â€¢ ä¼šè¯çŠ¶æ€
         â”‚    â€¢ ç”¨æˆ·è®¡æ•°
         â”‚    â€¢ é™æµæ•°æ®
         â”‚
         â””â”€â”€> Supabase (æŒä¹…åŒ–)
              â€¢ ä¼šè¯å†å²
              â€¢ ç”¨æˆ·é…é¢
              â€¢ ç»Ÿè®¡æ•°æ®
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rate Limiter (é™æµå™¨)                â”‚
â”‚  â€¢ æ—¥é…é¢æ£€æŸ¥                         â”‚
â”‚  â€¢ å®æ—¶è®¡æ•°                           â”‚
â”‚  â€¢ VIPåˆ¤æ–­                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Language Detector (è¯­è¨€è¯†åˆ«)        â”‚
â”‚  â€¢ ç®€ä½“ä¸­æ–‡/ç¹ä½“ä¸­æ–‡/è‹±æ–‡              â”‚
â”‚  â€¢ å›å¤é•¿åº¦è°ƒæ•´ç³»æ•°                   â”‚
â”‚  â€¢ ä¸Šä¸‹æ–‡è¯­è¨€ä¿æŒ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gemini Router (25 Keysæ± )           â”‚
â”‚  â€¢ æ™ºèƒ½è´Ÿè½½å‡è¡¡                       â”‚
â”‚  â€¢ æ•…éšœåˆ‡æ¢                           â”‚
â”‚  â€¢ é…é¢ç®¡ç†                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    AI Response
         â”‚
         â–¼
  Useræ”¶åˆ°å›å¤
```

## ğŸ’¾ æ•°æ®ç»“æ„è®¾è®¡

### 1. ä¼šè¯çŠ¶æ€ (Session)
```go
type Session struct {
    SessionID     string         `json:"session_id"`      // å”¯ä¸€ä¼šè¯ID
    UserID        int64          `json:"user_id"`         // Telegramç”¨æˆ·ID
    GroupID       int64          `json:"group_id"`        // ç¾¤ç»„ID
    Username      string         `json:"username"`        // ç”¨æˆ·å
    Language      string         `json:"language"`        // è¯­è¨€ (zh-CN, zh-TW, en)
    RoundCount    int            `json:"round_count"`     // å½“å‰è½®æ•° (1-5)
    MaxRounds     int            `json:"max_rounds"`      // æœ€å¤§è½®æ•° (5)
    Messages      []Message      `json:"messages"`        // æ¶ˆæ¯å†å²
    CreatedAt     time.Time      `json:"created_at"`      // åˆ›å»ºæ—¶é—´
    LastActiveAt  time.Time      `json:"last_active_at"`  // æœ€åæ´»è·ƒæ—¶é—´
    ExpireAt      time.Time      `json:"expire_at"`       // è¿‡æœŸæ—¶é—´
    Status        string         `json:"status"`          // active, expired, completed
}

type Message struct {
    Role      string    `json:"role"`       // user, assistant, system
    Content   string    `json:"content"`    // æ¶ˆæ¯å†…å®¹
    Timestamp time.Time `json:"timestamp"`  // æ—¶é—´æˆ³
    TokenCount int      `json:"token_count"` // Tokenæ•°é‡
}
```

### 2. ç”¨æˆ·é…é¢ (User Quota)
```go
type UserQuota struct {
    UserID          int64     `json:"user_id"`           // ç”¨æˆ·ID
    Username        string    `json:"username"`          // ç”¨æˆ·å
    IsOwner         bool      `json:"is_owner"`          // æ˜¯å¦Owner
    DailyLimit      int       `json:"daily_limit"`       // æ¯æ—¥é™åˆ¶ (10æ¬¡)
    UsedToday       int       `json:"used_today"`        // ä»Šæ—¥å·²ç”¨
    LastResetDate   string    `json:"last_reset_date"`   // ä¸Šæ¬¡é‡ç½®æ—¥æœŸ
    TotalCalls      int       `json:"total_calls"`       // æ€»è°ƒç”¨æ¬¡æ•°
    ActiveSessions  int       `json:"active_sessions"`   // å½“å‰æ´»è·ƒä¼šè¯æ•°
    CreatedAt       time.Time `json:"created_at"`
    UpdatedAt       time.Time `json:"updated_at"`
}
```

### 3. è¯­è¨€é…ç½® (Language Config)
```go
type LanguageConfig struct {
    Code              string  `json:"code"`               // zh-CN, zh-TW, en
    Name              string  `json:"name"`               // ç®€ä½“ä¸­æ–‡, ç¹é«”ä¸­æ–‡, English
    ResponseMultiplier float64 `json:"response_multiplier"` // å›å¤é•¿åº¦ç³»æ•°
    MaxTokens         int     `json:"max_tokens"`         // æœ€å¤§tokenæ•°
    SystemPrompt      string  `json:"system_prompt"`      // ç³»ç»Ÿæç¤ºè¯
}

var LanguageConfigs = map[string]LanguageConfig{
    "zh-CN": {
        Code:              "zh-CN",
        Name:              "ç®€ä½“ä¸­æ–‡",
        ResponseMultiplier: 0.9,    // ç¨çŸ­
        MaxTokens:         800,
        SystemPrompt:      "ä½ æ˜¯å°çˆ±åŒå­¦ï¼Œä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹ã€‚ç”¨ç®€æ´çš„ä¸­æ–‡å›å¤ã€‚",
    },
    "zh-TW": {
        Code:              "zh-TW",
        Name:              "ç¹é«”ä¸­æ–‡",
        ResponseMultiplier: 0.9,    // ç¨çŸ­
        MaxTokens:         800,
        SystemPrompt:      "ä½ æ˜¯å°æ„›åŒå­¸ï¼Œä¸€å€‹å‹å¥½çš„AIåŠ©æ‰‹ã€‚ç”¨ç°¡æ½”çš„ä¸­æ–‡å›è¦†ã€‚",
    },
    "en": {
        Code:              "en",
        Name:              "English",
        ResponseMultiplier: 1.3,    // ç¨é•¿
        MaxTokens:         1200,
        SystemPrompt:      "You are Xiaoai, a friendly AI assistant. Reply concisely in English.",
    },
}
```

### 4. Rediså­˜å‚¨ç»“æ„
```
Keyå‘½åè§„èŒƒ:

1. ä¼šè¯æ•°æ®:
   session:{user_id}:{group_id} -> Session JSON
   TTL: 30åˆ†é’Ÿ (æ— æ´»åŠ¨è‡ªåŠ¨è¿‡æœŸ)

2. æ´»è·ƒä¼šè¯åˆ—è¡¨:
   active_sessions:{group_id} -> Set[user_id]
   ç”¨äºé™åˆ¶æœ€å¤š5ä¸ªå¹¶å‘ä¼šè¯

3. ç”¨æˆ·ä»Šæ—¥é…é¢:
   quota:{user_id}:{date} -> count
   TTL: 24å°æ—¶ (æ¯æ—¥è‡ªåŠ¨é‡ç½®)

4. ç”¨æˆ·æ´»è·ƒä¼šè¯è®¡æ•°:
   user_sessions:{user_id} -> count
   
5. è¯­è¨€æ£€æµ‹ç¼“å­˜:
   lang:{user_id} -> language_code
   TTL: 7å¤©
```

## ğŸ”§ æ ¸å¿ƒæ¨¡å—å®ç°

### 1. Session Manager
```go
type SessionManager struct {
    redis    *redis.Client
    supabase *supabase.Client
    maxConcurrentSessions int  // 5
    sessionTimeout        time.Duration // 30åˆ†é’Ÿ
}

// åˆ›å»ºæ–°ä¼šè¯
func (sm *SessionManager) CreateSession(userID, groupID int64, username string) (*Session, error) {
    // 1. æ£€æŸ¥æ´»è·ƒä¼šè¯æ•°é‡
    activeCount := sm.GetActiveSessions GroupCount(groupID)
    if activeCount >= sm.maxConcurrentSessions {
        return nil, errors.New("ç¾¤ç»„ä¼šè¯æ•°é‡å·²è¾¾ä¸Šé™(5ä¸ª)")
    }
    
    // 2. æ£€æµ‹ç”¨æˆ·è¯­è¨€
    lang := sm.DetectLanguage(userID)
    
    // 3. åˆ›å»ºä¼šè¯
    session := &Session{
        SessionID:    fmt.Sprintf("%d_%d_%d", userID, groupID, time.Now().Unix()),
        UserID:       userID,
        GroupID:      groupID,
        Username:     username,
        Language:     lang,
        RoundCount:   0,
        MaxRounds:    5,
        Messages:     []Message{},
        CreatedAt:    time.Now(),
        LastActiveAt: time.Now(),
        ExpireAt:     time.Now().Add(sm.sessionTimeout),
        Status:       "active",
    }
    
    // 4. å­˜å‚¨åˆ°Redis
    key := fmt.Sprintf("session:%d:%d", userID, groupID)
    data, _ := json.Marshal(session)
    sm.redis.Set(context.Background(), key, data, sm.sessionTimeout)
    
    // 5. æ·»åŠ åˆ°æ´»è·ƒåˆ—è¡¨
    sm.redis.SAdd(context.Background(), fmt.Sprintf("active_sessions:%d", groupID), userID)
    
    return session, nil
}

// å¤„ç†æ¶ˆæ¯
func (sm *SessionManager) HandleMessage(userID, groupID int64, message string) (*Response, error) {
    // 1. è·å–æˆ–åˆ›å»ºä¼šè¯
    session, err := sm.GetSession(userID, groupID)
    if err != nil || session == nil {
        session, err = sm.CreateSession(userID, groupID, "")
        if err != nil {
            return nil, err
        }
    }
    
    // 2. æ£€æŸ¥è½®æ•°é™åˆ¶
    if session.RoundCount >= session.MaxRounds {
        sm.CloseSession(userID, groupID)
        return &Response{
            Content: "æœ¬è½®å¯¹è¯å·²ç»“æŸï¼Œå†æ¬¡@æˆ‘å¯å¼€å§‹æ–°çš„å¯¹è¯~",
            Final:   true,
        }, nil
    }
    
    // 3. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    session.Messages = append(session.Messages, Message{
        Role:      "user",
        Content:   message,
        Timestamp: time.Now(),
    })
    session.RoundCount++
    session.LastActiveAt = time.Now()
    
    // 4. è°ƒç”¨AIç”Ÿæˆå›å¤
    langConfig := LanguageConfigs[session.Language]
    aiResponse, err := sm.CallAI(session, langConfig)
    if err != nil {
        return nil, err
    }
    
    // 5. æ·»åŠ AIå›å¤
    session.Messages = append(session.Messages, Message{
        Role:      "assistant",
        Content:   aiResponse,
        Timestamp: time.Now(),
    })
    
    // 6. æ›´æ–°ä¼šè¯
    sm.UpdateSession(session)
    
    // 7. è¿”å›å“åº”
    isFinal := session.RoundCount >= session.MaxRounds
    return &Response{
        Content: aiResponse,
        Round:   session.RoundCount,
        Final:   isFinal,
    }, nil
}

// å…³é—­ä¼šè¯
func (sm *SessionManager) CloseSession(userID, groupID int64) error {
    // 1. æ ‡è®°ä¸ºå·²å®Œæˆ
    session, _ := sm.GetSession(userID, groupID)
    if session != nil {
        session.Status = "completed"
        sm.SaveToDatabase(session) // æŒä¹…åŒ–åˆ°Supabase
    }
    
    // 2. ä»Redisåˆ é™¤
    key := fmt.Sprintf("session:%d:%d", userID, groupID)
    sm.redis.Del(context.Background(), key)
    
    // 3. ä»æ´»è·ƒåˆ—è¡¨ç§»é™¤
    sm.redis.SRem(context.Background(), fmt.Sprintf("active_sessions:%d", groupID), userID)
    
    return nil
}
```

### 2. Rate Limiter
```go
type RateLimiter struct {
    redis     *redis.Client
    ownerID   int64
}

// æ£€æŸ¥é…é¢
func (rl *RateLimiter) CheckQuota(userID int64) (bool, error) {
    // Owneræ— é™åˆ¶
    if userID == rl.ownerID {
        return true, nil
    }
    
    // è·å–ä»Šæ—¥ä½¿ç”¨é‡
    date := time.Now().Format("2006-01-02")
    key := fmt.Sprintf("quota:%d:%s", userID, date)
    
    count, err := rl.redis.Get(context.Background(), key).Int()
    if err == redis.Nil {
        count = 0
    } else if err != nil {
        return false, err
    }
    
    // æ£€æŸ¥é™åˆ¶ (æ¯å¤©10æ¬¡)
    if count >= 10 {
        return false, errors.New("ä»Šæ—¥é…é¢å·²ç”¨å®Œï¼Œæ˜å¤©å†æ¥å§~")
    }
    
    return true, nil
}

// å¢åŠ ä½¿ç”¨è®¡æ•°
func (rl *RateLimiter) IncrementUsage(userID int64) error {
    // Ownerä¸è®¡æ•°
    if userID == rl.ownerID {
        return nil
    }
    
    date := time.Now().Format("2006-01-02")
    key := fmt.Sprintf("quota:%d:%s", userID, date)
    
    // é€’å¢
    rl.redis.Incr(context.Background(), key)
    
    // è®¾ç½®è¿‡æœŸæ—¶é—´ (24å°æ—¶)
    rl.redis.Expire(context.Background(), key, 24*time.Hour)
    
    return nil
}

// è·å–å‰©ä½™é…é¢
func (rl *RateLimiter) GetRemainingQuota(userID int64) int {
    if userID == rl.ownerID {
        return -1 // æ— é™åˆ¶
    }
    
    date := time.Now().Format("2006-01-02")
    key := fmt.Sprintf("quota:%d:%s", userID, date)
    
    count, err := rl.redis.Get(context.Background(), key).Int()
    if err != nil {
        count = 0
    }
    
    remaining := 10 - count
    if remaining < 0 {
        remaining = 0
    }
    
    return remaining
}
```

### 3. Language Detector
```go
type LanguageDetector struct {
    redis *redis.Client
}

// æ£€æµ‹è¯­è¨€
func (ld *LanguageDetector) Detect(text string) string {
    // ç®€å•è§„åˆ™æ£€æµ‹
    
    // æ£€æµ‹ç¹ä½“ä¸­æ–‡ç‰¹å¾å­—
    traditionalChars := []rune{'ç¹', 'é«”', 'ç¿’', 'å­¸', 'å€‘', 'å€‹', 'é€™', 'ä¾†', 'èªª', 'åœ‹'}
    traditionalCount := 0
    for _, char := range text {
        for _, tc := range traditionalChars {
            if char == tc {
                traditionalCount++
            }
        }
    }
    
    if traditionalCount > 0 {
        return "zh-TW"
    }
    
    // æ£€æµ‹ä¸­æ–‡ (ç®€ä½“)
    chineseCount := 0
    for _, char := range text {
        if char >= 0x4E00 && char <= 0x9FA5 {
            chineseCount++
        }
    }
    
    if float64(chineseCount)/float64(len([]rune(text))) > 0.3 {
        return "zh-CN"
    }
    
    // é»˜è®¤è‹±æ–‡
    return "en"
}

// è·å–ç”¨æˆ·è¯­è¨€ï¼ˆå¸¦ç¼“å­˜ï¼‰
func (ld *LanguageDetector) GetUserLanguage(userID int64, defaultText string) string {
    key := fmt.Sprintf("lang:%d", userID)
    
    // å°è¯•ä»ç¼“å­˜è¯»å–
    lang, err := ld.redis.Get(context.Background(), key).Result()
    if err == nil && lang != "" {
        return lang
    }
    
    // æ£€æµ‹è¯­è¨€
    detected := ld.Detect(defaultText)
    
    // ç¼“å­˜7å¤©
    ld.redis.Set(context.Background(), key, detected, 7*24*time.Hour)
    
    return detected
}
```

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: å•ç”¨æˆ·å¯¹è¯
```
User A: @å°çˆ± ä½ å¥½
Bot: ä½ å¥½ï¼æˆ‘æ˜¯å°çˆ±åŒå­¦ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ [1/5]

User A: ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·
Bot: æŠ±æ­‰ï¼Œæˆ‘ç›®å‰æ— æ³•æŸ¥è¯¢å®æ—¶å¤©æ°”... [2/5]

User A: è®²ä¸ªç¬‘è¯
Bot: å¥½çš„ï¼ä¸ºä»€ä¹ˆç•ªèŒ„... [3/5]

... (ç»§ç»­åˆ°5è½®)

User A: è¿˜æœ‰å‘¢
Bot: æœ¬è½®å¯¹è¯å·²ç»“æŸï¼Œå†æ¬¡@æˆ‘å¯å¼€å§‹æ–°çš„å¯¹è¯~
```

### åœºæ™¯2: å¤šç”¨æˆ·å¹¶å‘å¯¹è¯
```
[æ—¶é—´ 14:00:00]
User A: @å°çˆ± ä½ å¥½           -> åˆ›å»ºSession A (è½®æ•°: 1/5)
Bot -> User A: ä½ å¥½ï¼

[æ—¶é—´ 14:00:05]
User B: @å°çˆ± é—®ä¸ªé—®é¢˜       -> åˆ›å»ºSession B (è½®æ•°: 1/5)
Bot -> User B: è¯·è¯´ï¼

[æ—¶é—´ 14:00:10]
User A: ç»§ç»­åˆšæ‰çš„è¯é¢˜       -> Session A (è½®æ•°: 2/5)
Bot -> User A: å¥½çš„...

[æ—¶é—´ 14:00:15]
User B: é‚£ä¸ªé—®é¢˜çš„ç­”æ¡ˆ       -> Session B (è½®æ•°: 2/5)
Bot -> User B: è®©æˆ‘æƒ³æƒ³...

äº’ä¸å¹²æ‰°ï¼Œå„è‡ªç»´æŠ¤5è½®è®°å¿†ï¼
```

### åœºæ™¯3: è¾¾åˆ°å¹¶å‘ä¸Šé™
```
å½“å‰æ´»è·ƒ: User A, B, C, D, E (5ä¸ª)

User F: @å°çˆ± ä½ å¥½
Bot: æŠ±æ­‰ï¼Œå½“å‰ç¾¤ç»„å¯¹è¯äººæ•°å·²è¾¾ä¸Šé™(5äºº)ï¼Œè¯·ç¨åå†è¯•~

[User Açš„ä¼šè¯ç»“æŸ]

User F: @å°çˆ± ä½ å¥½           -> åˆ›å»ºæˆåŠŸ
Bot: ä½ å¥½ï¼...
```

### åœºæ™¯4: é…é¢é™åˆ¶
```
User X (æ™®é€šç”¨æˆ·):
- ä»Šæ—¥å·²ä½¿ç”¨: 9æ¬¡
- å‰©ä½™: 1æ¬¡

User X: @å°çˆ± ç¬¬10æ¬¡æé—®
Bot: å›å¤... [è¿™æ˜¯ä»Šå¤©æœ€åä¸€æ¬¡å•¦ï¼]

User X: @å°çˆ± ç¬¬11æ¬¡
Bot: æŠ±æ­‰ï¼Œä½ ä»Šå¤©çš„é…é¢å·²ç”¨å®Œ(10æ¬¡)ï¼Œæ˜å¤©å†æ¥å§~ ğŸŒ™

Owner:
- æ— é™åˆ¶ï¼
```

### åœºæ™¯5: è¯­è¨€è‡ªé€‚åº”
```
User (ç®€ä½“ä¸­æ–‡):
@å°çˆ± ä½ å¥½
Bot: ä½ å¥½ï¼æˆ‘æ˜¯å°çˆ±~ (ç®€æ´å›å¤, 800 tokens)

User (English):
@å°çˆ± Hello
Bot: Hello! I'm Xiaoai, your friendly AI assistant... (è¯¦ç»†å›å¤, 1200 tokens)

User (ç¹é«”ä¸­æ–‡):
@å°æ„› ä½ å¥½
Bot: ä½ å¥½ï¼æˆ‘æ˜¯å°æ„›~ (ç°¡æ½”å›è¦†, 800 tokens)
```

## ğŸš€ éƒ¨ç½²é…ç½®

### ç¯å¢ƒå˜é‡
```env
# Boté…ç½®
TELEGRAM_BOT_TOKEN=8076798362:AAFL1LaRlQnKJ_i87AyWW5EhkJkdCmOGJDg
BOT_OWNER_ID=ä½ çš„TelegramID

# Redisé…ç½®
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=
REDIS_DB=0

# Supabaseé…ç½®
SUPABASE_URL=https://qhgdymgxcbyhtxezvoqt.supabase.co
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# ä¼šè¯é…ç½®
MAX_CONCURRENT_SESSIONS=5
SESSION_TIMEOUT_MINUTES=30
MAX_ROUNDS_PER_SESSION=5

# é™æµé…ç½®
DAILY_QUOTA_PER_USER=10
OWNER_UNLIMITED=true

# AIé…ç½®
GEMINI_API_KEYS=key1,key2,key3...
```

### æ•°æ®åº“è¡¨ç»“æ„ (Supabase)
```sql
-- ä¼šè¯å†å²è¡¨
CREATE TABLE chat_sessions (
    id BIGSERIAL PRIMARY KEY,
    session_id VARCHAR(100) UNIQUE NOT NULL,
    user_id BIGINT NOT NULL,
    group_id BIGINT NOT NULL,
    username VARCHAR(100),
    language VARCHAR(10),
    round_count INT DEFAULT 0,
    max_rounds INT DEFAULT 5,
    messages JSONB,
    status VARCHAR(20),
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    INDEX idx_user_group (user_id, group_id),
    INDEX idx_status (status),
    INDEX idx_created (created_at DESC)
);

-- ç”¨æˆ·é…é¢è¡¨
CREATE TABLE user_quotas (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(100),
    is_owner BOOLEAN DEFAULT FALSE,
    daily_limit INT DEFAULT 10,
    used_today INT DEFAULT 0,
    last_reset_date DATE,
    total_calls INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ç»Ÿè®¡è¡¨
CREATE TABLE usage_stats (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    group_id BIGINT,
    session_id VARCHAR(100),
    rounds INT,
    tokens_used INT,
    language VARCHAR(10),
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_user (user_id),
    INDEX idx_date (created_at DESC)
);
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **Redisç¼“å­˜ä¼˜å…ˆ**
   - æ‰€æœ‰æ´»è·ƒä¼šè¯å­˜Redis
   - 30åˆ†é’Ÿåè‡ªåŠ¨è¿‡æœŸ
   - Supabaseä»…å­˜å†å²è®°å½•

2. **Tokenå‹ç¼©**
   - çŸ­æ¶ˆæ¯(<50å­—)ç­‰å¾…åç»­
   - æ™ºèƒ½åˆå¹¶ä¸Šä¸‹æ–‡
   - åªä¿ç•™æœ€è¿‘3è½®å®Œæ•´å†å²

3. **å¹¶å‘æ§åˆ¶**
   - æ¯ä¸ªç¾¤ç»„æœ€å¤š5ä¸ªå¹¶å‘
   - ä½¿ç”¨Redis SetåŸå­æ“ä½œ
   - é˜²æ­¢é›ªå´©

4. **è¯­è¨€æ£€æµ‹ç¼“å­˜**
   - æ£€æµ‹ä¸€æ¬¡ç¼“å­˜7å¤©
   - å‡å°‘é‡å¤è®¡ç®—

## âœ… æµ‹è¯•ç”¨ä¾‹

```bash
# 1. å•ç”¨æˆ·5è½®å¯¹è¯
# 2. 5ä¸ªç”¨æˆ·å¹¶å‘å¯¹è¯
# 3. ç¬¬6ä¸ªç”¨æˆ·è¢«æ‹’ç»
# 4. ç”¨æˆ·è¾¾åˆ°æ—¥é…é¢
# 5. Owneræ— é™åˆ¶
# 6. ä¼šè¯30åˆ†é’Ÿè¿‡æœŸ
# 7. è¯­è¨€è‡ªåŠ¨è¯†åˆ«
# 8. ä¸­è‹±æ–‡å›å¤é•¿åº¦ä¸åŒ
```

---

**è®¾è®¡å®Œæˆ**: 2025-11-09  
**æ ¸å¿ƒæ¨¡å—**: Session Manager + Rate Limiter + Language Detector  
**å¹¶å‘æ”¯æŒ**: 5ç”¨æˆ· Ã— 5è½® = 25ä¸ªæ´»è·ƒå¯¹è¯  
**é…é¢æ§åˆ¶**: 10æ¬¡/å¤© (Owneræ— é™)  
**è¯­è¨€æ”¯æŒ**: ç®€ä½“/ç¹ä½“/è‹±æ–‡ è‡ªé€‚åº” ğŸ„
