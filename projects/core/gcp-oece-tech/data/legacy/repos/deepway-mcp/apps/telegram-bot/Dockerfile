# =====================================================
# ğŸ§  SVSé«˜æƒ…å•†æ™ºèƒ½ä½“Dockeré•œåƒ
# å¤šé˜¶æ®µæ„å»ºï¼Œä¼˜åŒ–ä½“ç§¯
# =====================================================

# é˜¶æ®µ1: æ„å»ºç¯å¢ƒ
FROM python:3.11-slim as builder

WORKDIR /build

# å®‰è£…æ„å»ºä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir --user -r requirements.txt

# é˜¶æ®µ2: è¿è¡Œç¯å¢ƒ
FROM python:3.11-slim

# åˆ›å»ºérootç”¨æˆ·
RUN useradd -m -u 1000 svs && \
    mkdir -p /app/data /app/logs && \
    chown -R svs:svs /app

WORKDIR /app

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶ä¾èµ–
COPY --from=builder /root/.local /home/svs/.local
COPY --chown=svs:svs . .

# å®‰è£…Doppler CLI
RUN apt-get update && \
    apt-get install -y curl gnupg && \
    curl -Ls --tlsv1.2 --proto "=https" --retry 3 https://cli.doppler.com/install.sh | sh && \
    apt-get remove -y curl gnupg && \
    apt-get autoremove -y && \
    rm -rf /var/lib/apt/lists/*

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER svs

# ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PATH=/home/svs/.local/bin:$PATH \
    PYTHONPATH=/app

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import sys; import telegram; sys.exit(0)"

# æš´éœ²ç«¯å£(å¦‚æœéœ€è¦webhook)
EXPOSE 8080

# å¯åŠ¨å‘½ä»¤
CMD ["python", "-u", "high_eq_bot.py"]
