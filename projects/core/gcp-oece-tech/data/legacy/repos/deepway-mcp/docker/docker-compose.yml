version: '3.8'

# ==================================================
# ğŸ„ SVSç»Ÿä¸€é¡¹ç›® - 2vCPU/4GBä¼˜åŒ–é…ç½®
# åˆå¹¶svs-mcp (è®ºå›ç½‘ç«™) + svs_bot (Telegram)
# ç›®æ ‡: ç¨³å®šè¿è¡Œåœ¨$28/æœˆçš„VPSä¸Š
# ==================================================

services:
  # ==================== æ ¸å¿ƒæœåŠ¡ ====================
  
  # 1. Nginxåå‘ä»£ç† (32MB)
  nginx:
    image: nginx:alpine
    container_name: svs-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./static:/usr/share/nginx/html:ro
    networks:
      - svs-network
    depends_on:
      - forum-api
      - telegram-bot
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 32M
        reservations:
          cpus: '0.05'
          memory: 16M
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # 2. è®ºå›APIæœåŠ¡ (384MB)
  forum-api:
    build:
      context: ./svs-mcp/forum
      dockerfile: Dockerfile.alpine
      args:
        - NODE_ENV=production
    image: svs/forum-api:2v4g
    container_name: svs-forum-api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=300
      - PORT=3001
      - DATABASE_URL=postgresql://svs:${DB_PASSWORD}@postgres:5432/svs
      - REDIS_URL=redis://redis:6379
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_ANON_KEY}
      - SESSION_SECRET=${SESSION_SECRET}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      # è¿æ¥æ± ä¼˜åŒ–
      - DB_POOL_MIN=2
      - DB_POOL_MAX=10
      - DB_IDLE_TIMEOUT=10000
      - DB_CONNECTION_TIMEOUT=5000
    networks:
      - svs-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 384M
        reservations:
          cpus: '0.2'
          memory: 192M
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 3. Telegram BotæœåŠ¡ (256MB)
  telegram-bot:
    build:
      context: ./svs_bot
      dockerfile: Dockerfile.alpine
    image: svs/telegram-bot:2v4g
    container_name: svs-telegram-bot
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_SVSKILO_TOKEN}
      - BOT_OWNER_ID=${BOT_OWNER_ID}
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://svs:${DB_PASSWORD}@postgres:5432/svs
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      # Geminié…ç½®
      - GEMINI_API_KEYS=${GEMINI_API_KEYS}
      - GEMINI_MODEL=gemini-2.5-flash-8b-latest
      - MAX_RPM=8333
      # Pythonä¼˜åŒ–
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    volumes:
      - ./svs_bot/data:/app/data
      - ./svs_bot/logs:/app/logs
    networks:
      - svs-network
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          cpus: '0.15'
          memory: 128M
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 4. Geminiè·¯ç”±å™¨ (256MB)
  gemini-router:
    build:
      context: ./svs_bot
      dockerfile: Dockerfile.router
    image: svs/gemini-router:2v4g
    container_name: svs-gemini-router
    restart: unless-stopped
    environment:
      - GEMINI_API_KEYS=${GEMINI_API_KEYS}
      - REDIS_URL=redis://redis:6379
      - ROUTER_MODE=round-robin
      - MAX_RPM=8333
      - CACHE_TTL=300
      - LOG_LEVEL=INFO
    networks:
      - svs-network
    depends_on:
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          cpus: '0.15'
          memory: 128M
    healthcheck:
      test: ["CMD", "python", "-c", "import aiohttp; import sys; sys.exit(0)"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ==================== æ•°æ®å±‚ ====================
  
  # 5. PostgreSQLæ•°æ®åº“ (512MB)
  postgres:
    image: postgres:15-alpine
    container_name: svs-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=svs
      - POSTGRES_USER=svs
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      # 2v4gä¼˜åŒ–å‚æ•°
      - POSTGRES_MAX_CONNECTIONS=50
      - POSTGRES_SHARED_BUFFERS=128MB
      - POSTGRES_EFFECTIVE_CACHE_SIZE=512MB
      - POSTGRES_WORK_MEM=4MB
      - POSTGRES_MAINTENANCE_WORK_MEM=32MB
      - POSTGRES_WAL_BUFFERS=4MB
      - POSTGRES_CHECKPOINT_COMPLETION_TARGET=0.9
      - POSTGRES_RANDOM_PAGE_COST=1.1
      - POSTGRES_LOG_MIN_DURATION_STATEMENT=1000
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
      - ./database/backup:/backup
    networks:
      - svs-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U svs -d svs"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 6. Redisç¼“å­˜ (256MB)
  redis:
    image: redis:7-alpine
    container_name: svs-redis
    restart: unless-stopped
    command: >
      redis-server
      --maxmemory 200mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --appendonly yes
      --appendfsync everysec
      --tcp-keepalive 60
      --timeout 300
    volumes:
      - redis-data:/data
    networks:
      - svs-network
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          cpus: '0.15'
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ==================== å¯é€‰æœåŠ¡ ====================
  
  # 7. é™æ€æ–‡ä»¶æœåŠ¡å™¨ (å¯é€‰ï¼Œprofile: static)
  static-server:
    image: halverneus/static-file-server:latest
    container_name: svs-static
    restart: unless-stopped
    profiles: ["static"]
    environment:
      - PORT=8080
      - FOLDER=/web
      - SHOW_LISTING=false
      - CACHE_CONTROL_MAX_AGE=86400
    volumes:
      - ./static:/web:ro
      - ./images:/web/images:ro
      - ./tutorials:/web/tutorials:ro
    networks:
      - svs-network
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 32M
        reservations:
          cpus: '0.05'
          memory: 16M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "1"

# ==================== å·å®šä¹‰ ====================
volumes:
  postgres-data:
    driver: local
    name: svs_postgres_data
  redis-data:
    driver: local
    name: svs_redis_data

# ==================== ç½‘ç»œå®šä¹‰ ====================
networks:
  svs-network:
    driver: bridge
    name: svs_network
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16

# ==================================================
# èµ„æºä½¿ç”¨æ€»è§ˆ (2vCPU / 4GB RAM)
# ==================================================
#
# æœåŠ¡èµ„æºåˆ†é…:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ æœåŠ¡            â”‚ CPUé™åˆ¶  â”‚ å†…å­˜é™åˆ¶   â”‚ å®é™…å ç”¨ â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ nginx           â”‚ 0.1 vCPU â”‚ 32 MB     â”‚ ~10 MB   â”‚
# â”‚ forum-api       â”‚ 0.4 vCPU â”‚ 384 MB    â”‚ ~200 MB  â”‚
# â”‚ telegram-bot    â”‚ 0.3 vCPU â”‚ 256 MB    â”‚ ~100 MB  â”‚
# â”‚ gemini-router   â”‚ 0.3 vCPU â”‚ 256 MB    â”‚ ~80 MB   â”‚
# â”‚ postgres        â”‚ 0.5 vCPU â”‚ 512 MB    â”‚ ~300 MB  â”‚
# â”‚ redis           â”‚ 0.3 vCPU â”‚ 256 MB    â”‚ ~100 MB  â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ æ€»è®¡            â”‚ 1.9 vCPU â”‚ 1696 MB   â”‚ ~790 MB  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# å‰©ä½™èµ„æº:
# - CPU: 0.1 vCPU (5%)
# - RAM: 2.3 GB (ç³»ç»Ÿ + ç¼“å†² + Swap)
#
# ==================================================
# éƒ¨ç½²æŒ‡å—
# ==================================================
#
# 1. å‡†å¤‡ç¯å¢ƒ:
#    # åˆ›å»ºSwap (æ¨è)
#    sudo fallocate -l 2G /swapfile
#    sudo chmod 600 /swapfile
#    sudo mkswap /swapfile
#    sudo swapon /swapfile
#    echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
#
# 2. è®¾ç½®ç¯å¢ƒå˜é‡:
#    cp .env.example .env
#    # ç¼–è¾‘.envæ–‡ä»¶ï¼Œå¡«å…¥æ‰€æœ‰å¿…è¦çš„å¯†é’¥
#
# 3. æ„å»ºé•œåƒ:
#    docker-compose -f docker-compose.2v4g.yml build
#
# 4. å¯åŠ¨æœåŠ¡:
#    docker-compose -f docker-compose.2v4g.yml up -d
#
# 5. æŸ¥çœ‹çŠ¶æ€:
#    docker-compose -f docker-compose.2v4g.yml ps
#    docker stats --no-stream
#
# 6. æŸ¥çœ‹æ—¥å¿—:
#    docker-compose -f docker-compose.2v4g.yml logs -f
#
# 7. åœæ­¢æœåŠ¡:
#    docker-compose -f docker-compose.2v4g.yml down
#
# ==================================================
# ç›‘æ§å‘½ä»¤
# ==================================================
#
# # å®æ—¶èµ„æºç›‘æ§
# watch -n 2 docker stats --no-stream
#
# # å†…å­˜ä½¿ç”¨è¯¦æƒ…
# docker ps -q | xargs docker inspect -f '{{.Name}}: {{.HostConfig.Memory}}'
#
# # ç½‘ç»œè¿æ¥æ•°
# netstat -ant | grep -E ':80|:443|:3001' | wc -l
#
# # PostgreSQLè¿æ¥æ•°
# docker exec svs-postgres psql -U svs -c "SELECT count(*) FROM pg_stat_activity;"
#
# # Rediså†…å­˜ä½¿ç”¨
# docker exec svs-redis redis-cli INFO memory | grep used_memory_human
#
# ==================================================
# ä¼˜åŒ–å»ºè®®
# ==================================================
#
# 1. å¦‚æœå†…å­˜ç´§å¼ :
#    - å‡å°‘PostgreSQL shared_buffersåˆ°64MB
#    - å‡å°‘Redis maxmemoryåˆ°128MB
#    - å‡å°‘forum-apiå†…å­˜åˆ°256MB
#
# 2. å¦‚æœCPUç´§å¼ :
#    - é™ä½gemini-routerçš„MAX_RPM
#    - å¢åŠ Redisç¼“å­˜TTL
#    - å¯ç”¨Nginxé™æ€æ–‡ä»¶ç¼“å­˜
#
# 3. è¿›ä¸€æ­¥ä¼˜åŒ–:
#    - ä½¿ç”¨PgBouncerè¿æ¥æ± 
#    - å¯ç”¨Nginxç¼“å­˜
#    - ä½¿ç”¨CDNæ‰˜ç®¡é™æ€èµ„æº
#
# ==================================================
