version: '3.8'

# ğŸ¨ Hotel Management System - Google Cloud Production
# ç”Ÿäº§ç¯å¢ƒé…ç½® - é€‚é…Google Cloudå…¨å®¶æ¡¶

services:
  # ğŸ—„ï¸ PostgreSQL æ•°æ®åº“ (Cloud SQL æ›¿ä»£)
  # ä½¿ç”¨ Cloud SQL for PostgreSQL æ›¿ä»£æœ¬åœ°æ•°æ®åº“
  hotel-db:
    image: gcr.io/cloudsql-docker/gce-proxy:1.33
    container_name: hotel_database
    restart: unless-stopped
    environment:
      POSTGRES_DB: hotel_management
      POSTGRES_USER: hotel_admin
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ./docker-data/postgres:/var/lib/postgresql/data
    ports:
      - "${DB_PORT:-5432}:5432"
    networks:
      - hotel_network
    command: ["/cloud_sql_proxy", "-instances=${CLOUD_SQL_CONNECTION_NAME}=tcp:5432", "-credential_file=/secrets/service-account.json"]
    secrets:
      - service-account.json
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hotel_admin -d hotel_management"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # âš¡ Redis ç¼“å­˜ (Cloud Memorystore æ›¿ä»£)
  # ä½¿ç”¨ Cloud Memorystore for Redis æ›¿ä»£æœ¬åœ°Redis
  hotel-cache:
    image: redis:7-alpine
    container_name: hotel_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - ./docker-data/redis:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - hotel_network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  # ğŸš€ Node.js åç«¯API (Cloud Run éƒ¨ç½²)
  hotel-api:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: hotel_backend_api
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 8080
      DB_HOST: hotel-db
      DB_PORT: 5432
      DB_NAME: hotel_management
      DB_USER: hotel_admin
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: hotel-cache
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: "24h"
      CORS_ORIGIN: "https://your-frontend-domain.com"
      # Google Cloud é…ç½®
      GOOGLE_CLOUD_PROJECT: ${GCP_PROJECT_ID}
      CLOUD_SQL_CONNECTION_NAME: ${CLOUD_SQL_CONNECTION_NAME}
    volumes:
      - ./logs:/app/logs
    ports:
      - "${API_PORT:-8080}:8080"
    networks:
      - hotel_network
    depends_on:
      hotel-db:
        condition: service_healthy
      hotel-cache:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  # ğŸ¨ React å‰ç«¯ (Cloud Run + CDN)
  hotel-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: hotel_frontend_app
    restart: unless-stopped
    environment:
      REACT_APP_API_URL: https://your-api-domain.com
      REACT_APP_HOTEL_NAME: "Hotel Inistel"
      REACT_APP_MAX_ROOMS: "50"
      GENERATE_SOURCEMAP: "false"
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    networks:
      - hotel_network
    depends_on:
      - hotel-api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

networks:
  hotel_network:
    driver: bridge

secrets:
  service-account.json:
    file: ./secrets/service-account.json

# ğŸ”§ Google Cloud éƒ¨ç½²è¯´æ˜:
# 1. Cloud SQL for PostgreSQL:
#    - åœ¨ GCP Console åˆ›å»º Cloud SQL PostgreSQL å®ä¾‹
#    - è·å–è¿æ¥å: your-project:region:instance-name
#    - è®¾ç½®æ•°æ®åº“ç”¨æˆ·å’Œå¯†ç 
#
# 2. Cloud Memorystore for Redis:
#    - åˆ›å»º Redis å®ä¾‹
#    - è·å– Redis ä¸»æœºå’Œç«¯å£
#
# 3. Cloud Run éƒ¨ç½²:
#    - æ„å»ºå¹¶æ¨é€é•œåƒåˆ° Container Registry æˆ– Artifact Registry
#    - éƒ¨ç½²åˆ° Cloud Runï¼Œè®¾ç½®ç¯å¢ƒå˜é‡
#    - é…ç½® Cloud Load Balancer
#
# 4. Cloud Storage (é™æ€æ–‡ä»¶):
#    - ä¸Šä¼ å‰ç«¯é™æ€æ–‡ä»¶åˆ° Cloud Storage
#    - è®¾ç½® CDN å’Œ SSL è¯ä¹¦
#
# 5. Secret Manager:
#    - å­˜å‚¨æ•æ„Ÿé…ç½®å¦‚æ•°æ®åº“å¯†ç ã€JWTå¯†é’¥
#    - åœ¨ Cloud Run ä¸­å¼•ç”¨ secrets
#
# 6. Cloud Monitoring & Logging:
#    - é…ç½®æ—¥å¿—å¯¼å‡ºåˆ° Cloud Logging
#    - è®¾ç½®ç›‘æ§å‘Šè­¦è§„åˆ™

# ğŸ’° æˆæœ¬ä¼°ç®— (æŒ‰å°æ—¶è®¡ç®—):
# - Cloud SQL: ~$0.05/å°æ—¶ (db-f1-micro)
# - Cloud Memorystore: ~$0.02/å°æ—¶ (Basic 1GB)
# - Cloud Run: ~$0.04/å°æ—¶ (512MB + 1 vCPU)
# - Cloud Storage + CDN: ~$0.01/GB/æœˆ
# - æ€»è®¡: ~$3-5/å¤© (50ç”¨æˆ·è§„æ¨¡)
