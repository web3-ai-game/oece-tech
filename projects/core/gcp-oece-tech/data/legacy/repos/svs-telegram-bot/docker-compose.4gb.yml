version: '3.8'

# ğŸ„ èŒä¸ç½‘ç»œ - 4GBå†…å­˜ä¼˜åŒ–é…ç½®
# ä¸“ä¸ºé¢„ç®—å‹VPSè®¾è®¡ï¼Œå®é™…å†…å­˜å ç”¨ ~1.5GB

services:
  # ===== æ ¸å¿ƒæœåŠ¡ =====
  
  # Redis - ä¼˜åŒ–ç‰ˆ
  redis:
    image: redis:7-alpine
    container_name: mycelium-redis
    restart: unless-stopped
    command: >
      redis-server
      --maxmemory 300mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --appendonly yes
      --appendfsync everysec
    volumes:
      - redis_data:/data
    networks:
      - mycelium_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 300M
        reservations:
          memory: 150M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # Nginx - è½»é‡ç‰ˆ
  nginx:
    image: nginx:alpine
    container_name: mycelium-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certs:/etc/nginx/certs:ro
      - ./public:/usr/share/nginx/html:ro
    networks:
      - mycelium_network
    depends_on:
      - portal
      - forum
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 32M
        reservations:
          memory: 16M
    logging:
      driver: "json-file"
      options:
        max-size: "3m"
        max-file: "1"

  # ===== MVPæ ¸å¿ƒæœåŠ¡ =====
  
  # å°çˆ±Bot - è½»é‡ç‰ˆ
  xiaoai-bot:
    build:
      context: ./go_backend
      dockerfile: Dockerfile.alpine
    image: mycelium/xiaoai:v2-alpine
    container_name: xiaoai-bot
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - BOT_OWNER_ID=${BOT_OWNER_ID}
      - REDIS_URL=redis:6379
      - GEMINI_API_KEYS=${GEMINI_API_KEYS}
      - LOG_LEVEL=warn
      - GC_PERCENT=50
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - mycelium_network
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 80M
        reservations:
          memory: 40M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # Portal - æ¬¢è¿é¡µ + ç™»å½•
  portal:
    build:
      context: ./services/portal
      dockerfile: Dockerfile.alpine
      args:
        - NODE_ENV=production
    image: mycelium/portal:alpine
    container_name: mycelium-portal
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_ANON_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - REDIS_URL=redis:6379
      - NODE_OPTIONS=--max-old-space-size=150
    depends_on:
      - redis
    networks:
      - mycelium_network
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 180M
        reservations:
          memory: 90M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 60s
      timeout: 10s
      retries: 2
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # Forum - è®ºå› (MVPåŠŸèƒ½)
  forum:
    build:
      context: ./services/forum
      dockerfile: Dockerfile.alpine
    image: mycelium/forum:alpine
    container_name: mycelium-forum
    restart: unless-stopped
    environment:
      - DATABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_SERVICE_KEY}
      - REDIS_URL=redis:6379
      - ENABLE_MARKDOWN=true
      - ENABLE_MENTIONS=false
      - MAX_POST_SIZE=5000
    depends_on:
      - redis
    networks:
      - mycelium_network
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 180M
        reservations:
          memory: 90M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ===== å¯é€‰æœåŠ¡ (æŒ‰éœ€å¯åŠ¨) =====
  
  # Chat - èŠå¤©å®¤ (å¯é€‰)
  chat:
    build:
      context: ./services/chat
      dockerfile: Dockerfile.alpine
    image: mycelium/chat:alpine
    container_name: mycelium-chat
    restart: unless-stopped
    profiles: ["full"]  # ä»…åœ¨full profileæ—¶å¯åŠ¨
    environment:
      - REDIS_URL=redis:6379
      - XIAOAI_API_URL=http://xiaoai-bot:8080
      - WEBSOCKET_PORT=3001
      - MAX_CONNECTIONS=50
    depends_on:
      - redis
      - xiaoai-bot
    networks:
      - mycelium_network
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # Panel - ä¸ªäººé¢æ¿ (å¯é€‰)
  panel:
    build:
      context: ./services/panel
      dockerfile: Dockerfile.alpine
    image: mycelium/panel:alpine
    container_name: mycelium-panel
    restart: unless-stopped
    profiles: ["full"]  # ä»…åœ¨full profileæ—¶å¯åŠ¨
    environment:
      - DATABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_ANON_KEY}
      - REDIS_URL=redis:6379
      - XIAOAI_API_URL=http://xiaoai-bot:8080
      - ENABLE_XIAOAI_CHAT=true
    depends_on:
      - redis
      - xiaoai-bot
    networks:
      - mycelium_network
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # Admin - ç®¡ç†åå° (å¯é€‰)
  admin:
    build:
      context: ./services/admin
      dockerfile: Dockerfile.alpine
    image: mycelium/admin:alpine
    container_name: mycelium-admin
    restart: unless-stopped
    profiles: ["full"]  # ä»…åœ¨full profileæ—¶å¯åŠ¨
    environment:
      - DATABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_SERVICE_KEY}
      - REDIS_URL=redis:6379
      - ADMIN_SECRET=${ADMIN_SECRET}
      - ENABLE_ANALYTICS=true
    depends_on:
      - redis
    networks:
      - mycelium_network
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "3m"
        max-file: "1"

# ===== ç½‘ç»œé…ç½® =====
networks:
  mycelium_network:
    driver: bridge

# ===== æ•°æ®å· =====
volumes:
  redis_data:
    driver: local

# ===== ä½¿ç”¨è¯´æ˜ =====
# 
# 1. MVPæ¨¡å¼ (æœ€å°åŒ–ï¼Œ~800MB):
#    docker-compose -f docker-compose.4gb.yml up -d
#    å¯åŠ¨: Redis + Nginx + Xiaoai + Portal + Forum
#
# 2. å®Œæ•´æ¨¡å¼ (~1.5GB):
#    docker-compose -f docker-compose.4gb.yml --profile full up -d
#    å¯åŠ¨: æ‰€æœ‰æœåŠ¡
#
# 3. æŸ¥çœ‹èµ„æºä½¿ç”¨:
#    docker stats
#
# 4. å†…å­˜ç›‘æ§:
#    ./monitor.sh --watch
#
# ===== èµ„æºé¢„ç®— (4GBæœºå™¨) =====
#
# MVPæ¨¡å¼:
#   Redis:      300MB (é™åˆ¶) / ~150MB (å®é™…)
#   Nginx:       32MB (é™åˆ¶) / ~10MB (å®é™…)
#   Xiaoai:      80MB (é™åˆ¶) / ~30MB (å®é™…)
#   Portal:     180MB (é™åˆ¶) / ~80MB (å®é™…)
#   Forum:      180MB (é™åˆ¶) / ~80MB (å®é™…)
#   ----------------------------------------
#   æ€»è®¡:       772MB (é™åˆ¶) / ~350MB (å®é™…)
#   ç³»ç»Ÿ:       ~800MB
#   Swap:       2GB (å»ºè®®åˆ›å»º)
#   ----------------------------------------
#   å‰©ä½™:       2.4GBç‰©ç† + 2GBè™šæ‹Ÿ = 4.4GB
#
# å®Œæ•´æ¨¡å¼:
#   + Chat:     128MB (é™åˆ¶) / ~50MB (å®é™…)
#   + Panel:    128MB (é™åˆ¶) / ~50MB (å®é™…)  
#   + Admin:    128MB (é™åˆ¶) / ~50MB (å®é™…)
#   ----------------------------------------
#   æ€»è®¡:      1156MB (é™åˆ¶) / ~500MB (å®é™…)
#   å‰©ä½™:       2.0GBç‰©ç† + 2GBè™šæ‹Ÿ = 4GB
#
# ç»“è®º: 4GBå®Œå…¨å¤Ÿç”¨ï¼
