# ä¸¤ä¸ªç½‘ç«™ç³»ç»Ÿ - ç¯å¢ƒé…ç½®ä¸éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [ç¯å¢ƒå˜é‡é…ç½®](#ç¯å¢ƒå˜é‡é…ç½®)
2. [Doppler å¯†é’¥ç®¡ç†](#doppler-å¯†é’¥ç®¡ç†)
3. [Firebase é…ç½®](#firebase-é…ç½®)
4. [æ•°æ®åº“é…ç½®](#æ•°æ®åº“é…ç½®)
5. [éƒ¨ç½²è„šæœ¬](#éƒ¨ç½²è„šæœ¬)
6. [ç›‘æ§ä¸æ—¥å¿—](#ç›‘æ§ä¸æ—¥å¿—)

---

## ç¯å¢ƒå˜é‡é…ç½®

### oece.tech ç¯å¢ƒå˜é‡ (.env.local)

```bash
# åŸºç¡€é…ç½®
NEXT_PUBLIC_SITE_URL=https://oece.tech
NEXT_PUBLIC_API_URL=https://api.oece.tech
NODE_ENV=production

# Firebase é…ç½®
NEXT_PUBLIC_FIREBASE_API_KEY=xxx
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=oece-tech-firebase.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=oece-tech-firebase
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=oece-tech-firebase.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=xxx
NEXT_PUBLIC_FIREBASE_APP_ID=xxx

# MongoDB é…ç½®
MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/oece_tech_db

# Algolia æœç´¢é…ç½®
NEXT_PUBLIC_ALGOLIA_APP_ID=xxx
NEXT_PUBLIC_ALGOLIA_SEARCH_API_KEY=xxx
ALGOLIA_ADMIN_API_KEY=xxx

# Sentry ç›‘æ§
NEXT_PUBLIC_SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx

# Telegram Bot
TELEGRAM_BOT_TOKEN=xxx
TELEGRAM_WEBHOOK_URL=https://api.oece.tech/webhook/telegram

# Redis ç¼“å­˜ (Upstash)
UPSTASH_REDIS_URL=redis://xxx
UPSTASH_REDIS_TOKEN=xxx

# å›½é™…åŒ–
NEXT_PUBLIC_DEFAULT_LOCALE=zh
NEXT_PUBLIC_SUPPORTED_LOCALES=zh,en

# API å¯†é’¥
API_SECRET_KEY=xxx
JWT_SECRET=xxx
```

### deepweay.me ç¯å¢ƒå˜é‡ (.env.local)

```bash
# åŸºç¡€é…ç½®
NEXT_PUBLIC_SITE_URL=https://deepweay.me
NEXT_PUBLIC_API_URL=https://api.deepweay.me
NODE_ENV=production

# Firebase é…ç½®
NEXT_PUBLIC_FIREBASE_API_KEY=xxx
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=deepweay-me-firebase.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=deepweay-me-firebase
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=deepweay-me-firebase.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=xxx
NEXT_PUBLIC_FIREBASE_APP_ID=xxx

# MongoDB é…ç½®
MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/deepweay_me_db

# Gemini AI é…ç½®
NEXT_PUBLIC_GEMINI_API_KEY=xxx
GEMINI_MODEL=gemini-pro

# Telegram Bot (Love Bot)
TELEGRAM_LOVE_BOT_TOKEN=xxx
TELEGRAM_WEBHOOK_URL=https://api.deepweay.me/webhook/telegram

# N8n å·¥ä½œæµé…ç½®
N8N_API_URL=https://n8n.do.deepweay.me
N8N_API_KEY=xxx

# Redis ç¼“å­˜
UPSTASH_REDIS_URL=redis://xxx
UPSTASH_REDIS_TOKEN=xxx

# API å¯†é’¥
API_SECRET_KEY=xxx
JWT_SECRET=xxx
```

---

## Doppler å¯†é’¥ç®¡ç†

### Doppler é¡¹ç›®ç»“æ„

```
Doppler Workspace
â”œâ”€â”€ oece-tech-prod
â”‚   â”œâ”€â”€ dev        (å¼€å‘ç¯å¢ƒ)
â”‚   â”œâ”€â”€ staging    (æµ‹è¯•ç¯å¢ƒ)
â”‚   â””â”€â”€ prod       (ç”Ÿäº§ç¯å¢ƒ)
â”‚
â””â”€â”€ deepweay-prod
    â”œâ”€â”€ dev
    â”œâ”€â”€ staging
    â””â”€â”€ prod
```

### é…ç½® Doppler CLI

```bash
# å®‰è£… Doppler CLI
curl https://cli.doppler.com/install.sh | sh

# ç™»å½•
doppler login

# oece.tech - æœ¬åœ°å¼€å‘
doppler run --project oece-tech-prod --config dev -- npm run dev

# deepweay.me - æœ¬åœ°å¼€å‘
doppler run --project deepweay-prod --config dev -- npm run dev

# oece.tech - ç”Ÿäº§æ„å»º
doppler run --project oece-tech-prod --config prod -- npm run build

# deepweay.me - ç”Ÿäº§æ„å»º
doppler run --project deepweay-prod --config prod -- npm run build
```

### Doppler ç¯å¢ƒå˜é‡ç®¡ç†

åœ¨ Doppler Dashboard ä¸­åˆ›å»ºä»¥ä¸‹ secrets:

#### oece.tech-prod/dev
```
FIREBASE_API_KEY: xxx
MONGODB_URI: mongodb://localhost:27017/oece_tech_dev
ALGOLIA_ADMIN_API_KEY: xxx
SENTRY_DSN: https://dev@xxx.ingest.sentry.io/xxx
TELEGRAM_BOT_TOKEN: xxx (dev token)
```

#### oece.tech-prod/staging
```
FIREBASE_API_KEY: xxx
MONGODB_URI: mongodb+srv://staging:xxx@cluster.mongodb.net/oece_tech_staging
ALGOLIA_ADMIN_API_KEY: xxx
SENTRY_DSN: https://staging@xxx.ingest.sentry.io/xxx
TELEGRAM_BOT_TOKEN: xxx (staging token)
```

#### oece.tech-prod/prod
```
FIREBASE_API_KEY: xxx
MONGODB_URI: mongodb+srv://prod:xxx@cluster.mongodb.net/oece_tech_db
ALGOLIA_ADMIN_API_KEY: xxx
SENTRY_DSN: https://prod@xxx.ingest.sentry.io/xxx
TELEGRAM_BOT_TOKEN: xxx (prod token)
RATE_LIMIT_ENABLED: true
```

---

## Firebase é…ç½®

### åˆ›å»º Firebase é¡¹ç›®

```bash
# å®‰è£… Firebase CLI
npm install -g firebase-tools

# ç™»å½•
firebase login

# åˆ›å»ºä¸¤ä¸ª Firebase é¡¹ç›®
# 1. oece-tech-firebase
# 2. deepweay-me-firebase
```

### firebase.json é…ç½® (oece.tech)

```json
{
  "hosting": {
    "public": "out",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ],
    "headers": [
      {
        "source": "/api/**",
        "headers": [
          {
            "key": "Cache-Control",
            "value": "public, max-age=0, must-revalidate"
          }
        ]
      },
      {
        "source": "/**/*.js",
        "headers": [
          {
            "key": "Cache-Control",
            "value": "public, max-age=31536000, immutable"
          }
        ]
      }
    ]
  },
  "functions": {
    "source": "functions",
    "runtime": "nodejs20"
  }
}
```

### firebase.json é…ç½® (deepweay.me)

```json
{
  "hosting": {
    "public": "out",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "/api/**",
        "function": "api"
      },
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  },
  "functions": {
    "source": "functions",
    "runtime": "nodejs20",
    "memory": 512,
    "timeoutSeconds": 60
  }
}
```

### Firebase éƒ¨ç½²è„šæœ¬

#### oece.tech/scripts/deploy.sh
```bash
#!/bin/bash

set -e

echo "ğŸš€ éƒ¨ç½² oece.tech åˆ° Firebase"

# é€‰æ‹©ç¯å¢ƒ
ENVIRONMENT=${1:-prod}

# åŠ è½½ç¯å¢ƒå˜é‡
doppler run --project oece-tech-prod --config $ENVIRONMENT -- bash << 'EOF'

# æ„å»º
npm run build

# éƒ¨ç½²
firebase deploy \
  --project oece-tech-firebase \
  --only hosting \
  --token $FIREBASE_TOKEN

echo "âœ… oece.tech éƒ¨ç½²å®Œæˆ"

EOF
```

#### deepweay.me/scripts/deploy.sh
```bash
#!/bin/bash

set -e

echo "ğŸš€ éƒ¨ç½² deepweay.me åˆ° Firebase"

# é€‰æ‹©ç¯å¢ƒ
ENVIRONMENT=${1:-prod}

# åŠ è½½ç¯å¢ƒå˜é‡
doppler run --project deepweay-prod --config $ENVIRONMENT -- bash << 'EOF'

# æ„å»º
npm run build

# éƒ¨ç½²
firebase deploy \
  --project deepweay-me-firebase \
  --token $FIREBASE_TOKEN

echo "âœ… deepweay.me éƒ¨ç½²å®Œæˆ"

EOF
```

---

## æ•°æ®åº“é…ç½®

### MongoDB Atlas è®¾ç½®

#### oece.tech æ•°æ®åº“

```javascript
// scripts/init-oece-db.js
const { MongoClient } = require('mongodb');

const client = new MongoClient(process.env.MONGODB_URI);

async function initDatabase() {
  try {
    await client.connect();
    const db = client.db('oece_tech_db');

    // åˆ›å»ºé›†åˆ
    await db.createCollection('projects');
    await db.createCollection('tools');
    await db.createCollection('documents');
    await db.createCollection('users');
    await db.createCollection('searches');

    // åˆ›å»ºç´¢å¼•
    await db.collection('projects').createIndex({ name: 'text', description: 'text' });
    await db.collection('documents').createIndex({ title: 'text', content: 'text' });
    await db.collection('searches').createIndex({ createdAt: 1 }, { expireAfterSeconds: 86400 });

    console.log('âœ… oece.tech æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
  } finally {
    await client.close();
  }
}

initDatabase().catch(console.error);
```

#### deepweay.me æ•°æ®åº“

```javascript
// scripts/init-deepweay-db.js
const { MongoClient } = require('mongodb');

const client = new MongoClient(process.env.MONGODB_URI);

async function initDatabase() {
  try {
    await client.connect();
    const db = client.db('deepweay_me_db');

    // åˆ›å»ºé›†åˆ
    await db.createCollection('chats');
    await db.createCollection('messages');
    await db.createCollection('knowledge');
    await db.createCollection('users');
    await db.createCollection('conversions');

    // åˆ›å»ºç´¢å¼•
    await db.collection('chats').createIndex({ userId: 1, createdAt: -1 });
    await db.collection('messages').createIndex({ chatId: 1, timestamp: 1 });
    await db.collection('knowledge').createIndex({ title: 'text', content: 'text' });
    await db.collection('messages').createIndex({ createdAt: 1 }, { expireAfterSeconds: 7776000 });

    console.log('âœ… deepweay.me æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
  } finally {
    await client.close();
  }
}

initDatabase().catch(console.error);
```

### æ•°æ®åº“è¿æ¥æ± é…ç½®

```typescript
// lib/db.ts
import { MongoClient, MongoClientOptions } from 'mongodb';

const MONGODB_URI = process.env.MONGODB_URI;
const MONGODB_DB = process.env.MONGODB_DB || 'default_db';

if (!MONGODB_URI) {
  throw new Error('Please define the MONGODB_URI environment variable');
}

let cached = global.mongo;

if (!cached) {
  cached = global.mongo = { conn: null, promise: null };
}

export async function connectToDatabase() {
  if (cached.conn) {
    return cached.conn;
  }

  if (!cached.promise) {
    const opts: MongoClientOptions = {
      retryWrites: true,
      w: 'majority',
      maxPoolSize: 10,
      minPoolSize: 2,
    };

    cached.promise = MongoClient.connect(MONGODB_URI, opts).then((client) => {
      return {
        client,
        db: client.db(MONGODB_DB),
      };
    });
  }

  cached.conn = await cached.promise;
  return cached.conn;
}
```

---

## éƒ¨ç½²è„šæœ¬

### Docker éƒ¨ç½² (oece.tech)

#### Dockerfile
```dockerfile
FROM node:20-alpine

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./
RUN npm ci --only=production

# å¤åˆ¶æºç 
COPY . .

# æ„å»º
RUN npm run build

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨åº”ç”¨
CMD ["npm", "start"]
```

#### docker-compose.yml
```yaml
version: '3.9'

services:
  oece-tech:
    build: .
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      MONGODB_URI: mongodb://mongo:27017/oece_tech_db
    depends_on:
      - mongo
    restart: always

  mongo:
    image: mongo:7
    volumes:
      - mongo_data:/data/db
    environment:
      MONGO_INITDB_DATABASE: oece_tech_db
    restart: always

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    restart: always

volumes:
  mongo_data:
```

### GCP éƒ¨ç½²è„šæœ¬

#### deploy-to-gcp.sh
```bash
#!/bin/bash

set -e

PROJECT_ID=$1
SERVICE_NAME=$2
IMAGE_NAME=$3

echo "ğŸš€ éƒ¨ç½² $SERVICE_NAME åˆ° GCP"

# æ„å»º Docker é•œåƒ
docker build -t gcr.io/$PROJECT_ID/$IMAGE_NAME:latest .

# æ¨é€åˆ° Google Container Registry
docker push gcr.io/$PROJECT_ID/$IMAGE_NAME:latest

# éƒ¨ç½²åˆ° Cloud Run
gcloud run deploy $SERVICE_NAME \
  --image gcr.io/$PROJECT_ID/$IMAGE_NAME:latest \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --memory 512Mi \
  --cpu 1 \
  --timeout 60 \
  --set-env-vars ENVIRONMENT=production

echo "âœ… éƒ¨ç½²å®Œæˆ"
```

### PM2 é…ç½® (ç”Ÿäº§ç¯å¢ƒ)

#### ecosystem.config.js (oece.tech)
```javascript
module.exports = {
  apps: [
    {
      name: 'oece-tech',
      script: '.next/standalone/server.js',
      instances: 'max',
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3000,
      },
      error_file: './logs/pm2-err.log',
      out_file: './logs/pm2-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      max_memory_restart: '500M',
      merge_logs: true,
      autorestart: true,
      watch: false,
      max_restarts: 10,
      min_uptime: '10s',
    },
  ],
};
```

#### ecosystem.config.js (deepweay.me)
```javascript
module.exports = {
  apps: [
    {
      name: 'deepweay-api',
      script: 'server.js',
      instances: 'max',
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3001,
      },
      error_file: './logs/pm2-err.log',
      out_file: './logs/pm2-out.log',
      max_memory_restart: '500M',
    },
    {
      name: 'deepweay-bot',
      script: 'bot.js',
      instances: 1,
      env: {
        NODE_ENV: 'production',
      },
      error_file: './logs/bot-err.log',
      out_file: './logs/bot-out.log',
      autorestart: true,
      watch: false,
    },
  ],
};
```

---

## ç›‘æ§ä¸æ—¥å¿—

### Sentry é…ç½®

#### sentry.config.js (oece.tech)
```javascript
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  integrations: [
    new Sentry.Replay({
      maskAllText: true,
      blockAllMedia: true,
    }),
  ],
  replaysSessionSampleRate: 0.1,
  replaysOnErrorSampleRate: 1.0,
});
```

### æ—¥å¿—æ”¶é›†

#### Logger æœåŠ¡
```typescript
// lib/logger.ts
import winston from 'winston';
import * as Sentry from "@sentry/nextjs";

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
  ],
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(
    new winston.transports.Console({
      format: winston.format.simple(),
    })
  );
}

export function logError(error: Error, context?: string) {
  logger.error(error.message, { stack: error.stack, context });
  Sentry.captureException(error);
}

export default logger;
```

### ç›‘æ§å‘Šè­¦è§„åˆ™

#### GCP Cloud Monitoring
```yaml
# alerting-policy.yaml
displayName: oece.tech é«˜é”™è¯¯ç‡
conditions:
  - displayName: é”™è¯¯ç‡ > 5%
    conditionThreshold:
      filter: |
        resource.type="cloud_run_revision"
        metric.type="run.googleapis.com/request_count"
        resource.label.service_name="oece-tech"
      comparison: COMPARISON_GT
      thresholdValue: 0.05
      duration: 300s
      aggregations:
        - alignmentPeriod: 60s
          perSeriesAligner: ALIGN_RATE
```

---

## å¿«é€Ÿå¯åŠ¨å‘½ä»¤

### å¼€å‘ç¯å¢ƒ

```bash
# oece.tech
cd /mnt/sms/02_æ ¸å¿ƒäº§å“/oece-tech
doppler run --project oece-tech-prod --config dev -- npm run dev

# deepweay.me
cd /mnt/sms/02_æ ¸å¿ƒäº§å“/deepweay-me
doppler run --project deepweay-prod --config dev -- npm run dev
```

### ç”Ÿäº§éƒ¨ç½²

```bash
# oece.tech
cd /mnt/sms/02_æ ¸å¿ƒäº§å“/oece-tech
./scripts/deploy.sh prod

# deepweay.me
cd /mnt/sms/02_æ ¸å¿ƒäº§å“/deepweay-me
./scripts/deploy.sh prod
```

---

**æœ€åæ›´æ–°**: 2026-01-15 14:45:00
