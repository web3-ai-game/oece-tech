version: '3.8'

# ğŸŒŠ DeepWeay æ•¸æ“šæ´—æ»Œå®¹å™¨
# å•Ÿå‹•: docker-compose -f docker-compose.washer.yml up -d

services:
  data-washer:
    image: node:20-alpine
    container_name: deepweay-data-washer
    working_dir: /app
    
    # 2vCPU + 2GB RAM
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    
    # 5GB å­˜å„²
    volumes:
      - ./scripts:/app/scripts:ro
      - ./package.json:/app/package.json:ro
      - washer-data:/app/data
    
    environment:
      - NODE_ENV=production
      - MONGODB_URI=${MONGODB_URI}
      - GEMINI_API_KEY_1=${GEMINI_API_KEY_1}
      - GEMINI_API_KEY_2=${GEMINI_API_KEY_2}
      - GEMINI_API_KEY_3=${GEMINI_API_KEY_3}
      - GEMINI_API_KEY_4=${GEMINI_API_KEY_4}
    
    # å®‰è£ä¾è³´ä¸¦é‹è¡Œ
    command: >
      sh -c "
        npm install mongodb axios --silent &&
        echo 'ğŸŒŠ æ•¸æ“šæ´—æ»Œå¼•æ“å•Ÿå‹•' &&
        node /app/scripts/data-washer.js
      "
    
    # æ¯å°æ™‚é‹è¡Œä¸€æ¬¡
    restart: "no"
    
    # æ—¥èªŒé…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # å®šæ™‚èª¿åº¦å™¨ (æ¯å°æ™‚åŸ·è¡Œæ´—æ»Œ)
  washer-scheduler:
    image: alpine:latest
    container_name: deepweay-scheduler
    depends_on:
      - data-washer
    
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    
    # æ¯å°æ™‚é‡å•Ÿ data-washer
    command: >
      sh -c "
        apk add --no-cache docker-cli &&
        while true; do
          echo '[èª¿åº¦å™¨] ç­‰å¾… 1 å°æ™‚...' &&
          sleep 3600 &&
          echo '[èª¿åº¦å™¨] è§¸ç™¼æ•¸æ“šæ´—æ»Œ' &&
          docker restart deepweay-data-washer
        done
      "
    
    restart: unless-stopped

volumes:
  washer-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/washer
