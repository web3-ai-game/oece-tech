// ğŸ”’ Firestore å®‰å…¨è§„åˆ™ï¼ˆç”Ÿäº§çº§ï¼‰
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
    function isAuthenticated() {
      return request.auth != null;
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰ç”¨æˆ·
    function isCurrentUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superadmin'];
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥è´¦å·æ˜¯å¦å¯ç”¨
    function isActiveAccount(userId) {
      let userData = get(/databases/$(database)/documents/users/$(userId)).data;
      return userData.status == 'active';
    }

    // ============================================
    // ç”¨æˆ·æ•°æ®
    // ============================================
    match /users/{userId} {
      // ä»»ä½•äººå¯è¯»ï¼ˆç”¨äºæ˜¾ç¤ºç”¨æˆ·å/å¤´åƒï¼‰
      allow read: if true;

      // ä»…ç”¨æˆ·æœ¬äººå¯åˆ›å»ºï¼ˆæ³¨å†Œæ—¶ï¼‰
      allow create: if isCurrentUser(userId) &&
                       request.resource.data.uid == userId &&
                       request.resource.data.email == request.auth.token.email;

      // ä»…ç”¨æˆ·æœ¬äººå¯æ›´æ–°ï¼ˆé™¤äº†æ•æ„Ÿå­—æ®µï¼‰
      allow update: if isCurrentUser(userId) &&
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['role', 'tier', 'tokens', 'createdAt']);

      // ä»…ç®¡ç†å‘˜å¯åˆ é™¤
      allow delete: if isAdmin();
    }

    // ============================================
    // å¯¹è¯å†å²
    // ============================================
    match /conversations/{conversationId} {
      // ä»…åˆ›å»ºè€…å¯è¯»
      allow read: if isCurrentUser(resource.data.userId);

      // ä»…è®¤è¯ç”¨æˆ·å¯åˆ›å»º
      allow create: if isCurrentUser(request.resource.data.userId);

      // ä»…åˆ›å»ºè€…å¯æ›´æ–°å’Œåˆ é™¤
      allow update, delete: if isCurrentUser(resource.data.userId);
    }

    // ============================================
    // ç”¨æˆ·æ´»åŠ¨æ—¥å¿—
    // ============================================
    match /activities/{activityId} {
      // ä»…ç”¨æˆ·æœ¬äººå¯è¯»è‡ªå·±çš„æ—¥å¿—
      allow read: if isCurrentUser(resource.data.userId);

      // ç³»ç»Ÿåˆ›å»ºï¼Œç¦æ­¢æ‰‹åŠ¨åˆ›å»º
      allow create: if false;

      // ç¦æ­¢æ›´æ–°å’Œåˆ é™¤
      allow update, delete: if false;
    }

    // ============================================
    // è®ºå›å¸–å­
    // ============================================
    match /forum_posts/{postId} {
      // æ‰€æœ‰äººå¯è¯»
      allow read: if true;

      // è®¤è¯ç”¨æˆ·å¯åˆ›å»º
      allow create: if isAuthenticated() &&
                       isActiveAccount(request.auth.uid) &&
                       request.resource.data.userId == request.auth.uid;

      // ä»…åˆ›å»ºè€…å¯æ›´æ–°
      allow update: if isCurrentUser(resource.data.userId) ||
                       isAdmin();

      // ä»…åˆ›å»ºè€…æˆ–ç®¡ç†å‘˜å¯åˆ é™¤
      allow delete: if isCurrentUser(resource.data.userId) ||
                       isAdmin();
    }

    // ============================================
    // è®ºå›å›å¤
    // ============================================
    match /forum_replies/{replyId} {
      // æ‰€æœ‰äººå¯è¯»
      allow read: if true;

      // è®¤è¯ç”¨æˆ·å¯åˆ›å»º
      allow create: if isAuthenticated() &&
                       isActiveAccount(request.auth.uid) &&
                       request.resource.data.userId == request.auth.uid;

      // ä»…åˆ›å»ºè€…å¯æ›´æ–°
      allow update: if isCurrentUser(resource.data.userId);

      // ä»…åˆ›å»ºè€…æˆ–ç®¡ç†å‘˜å¯åˆ é™¤
      allow delete: if isCurrentUser(resource.data.userId) ||
                       isAdmin();
    }

    // ============================================
    // è®ºå›ç‚¹èµ
    // ============================================
    match /forum_likes/{likeId} {
      // æ‰€æœ‰äººå¯è¯»
      allow read: if true;

      // è®¤è¯ç”¨æˆ·å¯åˆ›å»ºå’Œåˆ é™¤è‡ªå·±çš„ç‚¹èµ
      allow create, delete: if isAuthenticated() &&
                               isCurrentUser(request.resource.data.userId);

      // ç¦æ­¢æ›´æ–°
      allow update: if false;
    }

    // ============================================
    // é‚€è¯·ç 
    // ============================================
    match /invites/{inviteCode} {
      // æ‰€æœ‰äººå¯è¯»ï¼ˆç”¨äºéªŒè¯ï¼‰
      allow read: if true;

      // ä»…ç”¨æˆ·æœ¬äººå¯åˆ›å»ºè‡ªå·±çš„é‚€è¯·ç 
      allow create: if isCurrentUser(request.resource.data.ownerId);

      // ç³»ç»Ÿæ ‡è®°ä¸ºå·²ä½¿ç”¨
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['used', 'usedBy', 'usedAt']);

      // ç¦æ­¢åˆ é™¤
      allow delete: if false;
    }

    // ============================================
    // API Keys
    // ============================================
    match /api_keys/{keyId} {
      // ä»…æ‰€æœ‰è€…å¯è¯»
      allow read: if isCurrentUser(resource.data.userId);

      // ä»…æ‰€æœ‰è€…å¯åˆ›å»º
      allow create: if isCurrentUser(request.resource.data.userId);

      // ä»…æ‰€æœ‰è€…å¯æ›´æ–°ï¼ˆé™¤äº†ä½¿ç”¨ç»Ÿè®¡ï¼‰
      allow update: if isCurrentUser(resource.data.userId) ||
                       (request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['usageCount', 'lastUsedAt']));

      // ä»…æ‰€æœ‰è€…å¯åˆ é™¤
      allow delete: if isCurrentUser(resource.data.userId);
    }

    // ============================================
    // é»˜è®¤è§„åˆ™ï¼šæ‹’ç»æ‰€æœ‰å…¶ä»–è®¿é—®
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
