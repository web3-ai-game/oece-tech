---
distilled_by: grok-4-0709
mode: B
---
part: 2
---

## 2. Doppler 的核心功能

Doppler 的核心功能围绕密钥的集中管理和安全分发展开。它不仅仅是一个存储工具，还提供版本控制、回滚和团队协作特性。

### 2.1 密钥集中管理

背景：传统密钥管理依赖本地文件或环境变量，容易导致版本冲突。Doppler 的原理是云端存储所有密钥，并通过 Dashboard 或 CLI 进行统一访问。

#### 2.11 添加和管理密钥

原理：密钥以键值对形式存储，支持多类型（如字符串、JSON）。实例：添加一个数据库 URL，键名为 `DB_URL`，值加密存储。

代码範例1：使用 CLI 添加密钥（註釋：首先安裝 Doppler CLI，然後登入）

```bash
# 安裝 Doppler CLI (假設使用 Homebrew on macOS)
brew install dopplerhq/cli/doppler

# 登入 Doppler 帳戶
doppler login

# 切換到項目並添加密钥
doppler setup --project my-app --config dev
doppler secrets set DB_URL "postgres://user:pass@host:5432/db"
# 註釋：這將密钥安全上傳到云端，不會本地存儲
```

#### 2.12 多环境配置

背景：开发、测试、生产环境需要隔离密钥。原理：Doppler 提供预定义环境如 `dev`、`stg`、`prd`，每个环境有独立的密钥集。

代码範例2：切換環境並注入密钥（註釋：用於本地開發）

```bash
# 切換到 staging 環境
doppler setup --project my-app --config stg

# 運行應用並注入密钥
doppler run -- node server.js
# 註釋：Doppler 會將 stg 環境的密钥注入為環境變量，應用程式可直接使用 process.env.DB_URL
```

### 2.2 安全与合规功能

Doppler 强调密钥的安全生命周期管理，包括版本控制和审计。

#### 2.21 版本控制与回滚

原理：每當密钥更新，Doppler 自動創建版本快照，支持一鍵回滾。背景：這防止了錯誤更新導致系統崩潰。

實例：如果一個 API Key 被洩露，團隊可以回滾到先前版本，並調查日志。

#### 2.22 團隊權限管理

背景：在大型團隊中，不同角色需要不同訪問權限。原理：基於 RBAC（Role-Based Access Control），分配讀取/寫入權限。

表格：常見角色權限對比

| 角色        | 讀取權限 | 寫入權限 | 審計訪問 |
|-------------|----------|----------|----------|
| Developer  | 是      | 部分    | 否      |
| Admin      | 是      | 是      | 是      |
| Auditor    | 否      | 否      | 是      |

### 2.3 端到端集成

Doppler 支持與本地、CI/CD 和雲服務集成。

#### 2.31 本地開發集成

原理：通過 CLI 注入密钥到本地進程。

代码範例3：Python 應用集成（註釋：用於 Flask 或 Django）

```python
# app.py
import os
db_url = os.getenv('DB_URL')  # Doppler 注入的環境變量

# 運行命令：doppler run -- python app.py
# 註釋：這確保本地開發無需硬編碼密钥
```

#### 2.32 CI/CD 集成（如 GitHub Actions）

背景：CI/CD 是密钥洩露高風險區。原理：使用 Service Tokens 安全注入。

代码範例4：GitHub Actions YAML（註釋：用於部署）

```yaml
name: Deploy to Cloud Run

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install Doppler CLI
        run: curl -Ls --tlsv1.2 --proto "=https" --retry 3 https://cli.doppler.com/install.sh | sh
      - name: Fetch secrets
        run: doppler secrets download --no-file --format env > .env
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}  # Service Token 從 GitHub Secrets 注入
      # 註釋：這將密钥下載為 .env 文件，用於構建過程
```

#### 2.33 云服務集成（如 GCP Cloud Run）

原理：與 GCP Secret Manager 集成，實現自動化部署。

代码範例5：Cloud Run 部署腳本（註釋：使用 gcloud CLI）

```bash
# 假設已配置 Doppler Service Token
gcloud run deploy my-service --image gcr.io/my-project/image --set-env-vars="DOPPLER_TOKEN=$DOPPLER_TOKEN"
# 在容器啟動時運行 doppler run -- your-command
# 註釋：這允許 Cloud Run 容器從 Doppler 拉取密钥
```
